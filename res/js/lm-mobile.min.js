var URL_LM="https://apollo.omcompany.com:5443/api/";var URL_IMAGE="https://apollo.omcompany.com:5443/image/";function TAGi(a,b){return TAGl(imageLM(a,"m"),imageLM(a,"X"),b,true)}function TAGl(d,e,f,c){e=e||d;if(!c){f=f||160}var b="shadow"+(c?" autoScaleImage":"");var a="src='"+d+"'"+(f?" style='width:"+f+"px;height:"+f+"px'":"");return TAG("a","imglightbox","href='"+e+"' rel='player=img'",TAG("img",b,a,""))}function LINK(c,d){var b=d||c;b=truncateText(b,40);var a=" target='_blank'";if(c.indexOf("http://lm.twbbs.org")==0||c.indexOf("http://andy0130tw.qov.tw")==0||c.indexOf("http://learnmode.host22.com")==0){a=""}return TAG("a","","href='"+c+"'"+a,ICON("new-tab-2")+" "+b)}function extractDate(a){return new Date(a.getFullYear(),a.getMonth(),a.getDate())}function dateGetDays(b){var a=Math.round((extractDate(new Date())-extractDate(b))/86400000);if(a==0){return"今天"}if(a==1){return"昨天"}if(a==2){return"前天"}if(a<=7){return a+"天前"}return false}function imageLM(b,a){return URL_IMAGE+b+(a?"?size="+a:"")}function nl2br(a){return a.replace(/\n/g,"<br/>\n")}function urlToLink(b){var a=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|;])/ig;return b.replace(a,function(d,g,e,f,c){return" "+LINK(g)})}function normalize(a){return a.replaceAll('\\"','"').replaceAll("\\\\","\\").replaceAll("\\'","'").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("ς","　")}function markupContent(a){a=a.replace(/--\s*(.+?)\s*--/g,"<del>$1</del>").replace(/\*\*\*\s*(.+?)\s*\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*\s*(.*?)\s*\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,function(c,e,d,b){if(e.match(/^\s+|\s+$/g)){return c}return"<em>"+e+"</em>"}).replace(/__\s*(.+?)__\s*/g,"<u>$1</u>");return a}function processContent(c,a){if(a){var b=smartTrimmer(c);if(b){return nl2br(urlToLink(markupContent(normalize(b))))+TAG("span","text-muted","…(Read More)")}}return nl2br(urlToLink(markupContent(normalize(c))))}function extractSubject(c){var b=[];for(var a=0;a<c.length;++a){b.push(c[a].id)}return b}function needSubject(c){var a=["question","answer","!badge","watch","annotation"];for(var b=0;b<a.length;++b){if(c==a[b]){return true}}return false}
/*!Main body starts here*/
;var oldest="";var id="";var CATEGORY={share:"愛分享",question:"大哉問",scrapbook:"剪貼簿"};$(function(){$("a[href='#']").attr("href","javascript:void(0)");initListeners();$(window).on("hashchange",hashChangeHandler);hashChangeHandler()});function initListeners(){$("#menu-title").click(function(){$("body,html").animate({scrollTop:0},600)});$("#btn-loadmore").click(function(){$("#post-loading").removeClass("hide");loadFromLM("list",{related:id,before:oldest,sort:"date"},addRelated)})}function addLightBox(){$("div.vnbx").remove();$("a.imglightbox").each(function(){$(this).vanillabox()})}function hashChangeHandler(){var a=location.hash;id=a.substr(1);if(!id){$("#post-main").html(TAG("h2","text-alert","Error: No post id specified."));return}$("#post-related").empty();loadMainPost({id:id});loadRelated({related:id,count:30,sort:"date"});console.log("[hashChangeHandler] "+a)}function loadFromLM(c,b,d,a){b=b||{};if(!b.device){b.device=$.cookie("mac")}return $.ajax({url:urlParam(URL_LM+c,b),dataType:"jsonp",timeout:40000,success:function(e){if(e.status=="ok"){d(e)}else{if(a){a(e.message)}var f=valueOrOriginal(e.message,HASH.failureTranslation);console.log("載入資料失敗 from LM!<br/>訊息: *** "+f+" ***")}},error:function(f,g,e){if(g=="abort"){console.log("嘗試重新整理中...",3000);return}console.log("無法與 LM 連線!<br/>錯誤訊息: "+HASH.exception[g].txt)}})}function modifyObj(c,b){var d=new Date();c._user=b.users[c.from];if(b.related){c._related=c.related?b.related[c.related]:null;c._related_user=c.related?b.users[c._related.from]:null}if(c.voters){for(var a=0;a<c.voters.length;++a){c.voters[a]=b.users[c.voters[a]]}}return c}function loadMainPost(a){loadFromLM("read",a,function(c){var b=modifyObj(c.list[0],c);$("#post-float").html(TAG("span","fg-darkCyan",TAG("span","title",CATEGORY[b.category]+" "+b.score)+" Pts<br/>")+TAG("span","fg-grayLight",b.ref_count+" 則回應"));$("#post-main").html(renderPost(b));addLightBox()})}function renderPost(a){return TAG("img","user-avatar shadow place-left","src='"+imageLM(a._user.image)+"'","")+TAG("div","user-sub",renderUserRaw(a._user)+"<br/>"+TAG("div","user-datetime",dateConverter(a.date)))+TAG("div","user-message",processContent(a.message)+(a.image?"<br/>"+TAGi(a.image):""))}function loadRelated(a){$("#post-loading").removeClass("hide");loadFromLM("list",a,addRelated)}function addRelated(e){oldest=e.info.oldest;var b=[];for(var a in e.list){var d=modifyObj(e.list[a],e);b.push(renderPost(d))}var c=$("#post-related");var f=c.html();c.html(f+b.join("<hr/>")+"<hr/>");switchEnabled("#btn-loadmore",e.info.more);$("#post-loading").addClass("hide");addLightBox()}function renderUserRaw(a){if(a.roles[0]=="teacher"){return TAG("strong","user-name ol-indigo","style='outline:3px dotted;'",a.name)}return TAG("strong","user-name",a.name)};