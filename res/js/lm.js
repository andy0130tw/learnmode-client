function LMLoader(){var b=this;b.respInfo=null;b.action="";b.lastReq=null;b.xhr=null;b.target=null;b.dummyContent="";b.clearBefore=false;b.preLoad=null;b.loadFunc=null;b.parse=null;b.render=null;var a=function(e){var c=b.lastReq;if(!c.sort&&c.after){e.list.reverse()}var d=b.parse(e);b.respInfo=e.info;b.render(d)};b.load=function(c,d){b.clear();b.respInfo=null;b.action=c;b.lastReq=d;var e=b.preLoad();if(e){if(b.xhr){b.xhr.abort()}b.xhr=b.loadFunc(c,d,a)}};b.loadMore=function(){b.clearBefore=false;if(!b.respInfo){return}var c=b.lastReq;if(c.after){if(c.sort=="date"){b.lastReq.after=b.respInfo.oldest}else{b.lastReq.after=b.respInfo.newest}}else{b.lastReq.before=b.respInfo.oldest}var d=b.preLoad();if(d){if(b.xhr){b.xhr.abort()}xhr=b.loadFunc(b.action,b.lastReq,a)}};b.clear=function(){if(b.target===null){throw new Error("LMLoader, no target to clear.")}$('*[data-toggle="popover"]').popover("destroy");if(!b.dummyContent){b.dummyContent=b.target.html()}b.target.html(b.dummyContent)}}var mainLoader=null;$(function(){mainLoader=new LMLoader();mainLoader.loadFunc=loadFromLM;mainLoader.parse=parsePostListView;mainLoader.preLoad=function(){setShow("#main-loading","",false);$("#main-loading").html(getLoadingRing("center")+"<hr/>");viewRecognize(this.lastReq,this.clearBefore);if(this.lastReq.category=="__badge"){addToAward(currentProfile.badges);setShow("#main-loading","",true);return false}return true};mainLoader.render=addToContent;mainLoader.target=$("#mainContent")});function parsePostListView(e){var b=e.list;var c=[];for(var a in b){var d=modifyObj(b[a],e);c.push(renderPostListView(d))}if(!c.length){return false}return c.join("")}function parsePostThumbView(e){var c=e.list;var b=[];for(var a in c){b.push(renderPostImageView(modifyObj(c[a],e)))}var d=processGrid(b,4);return TAG("div","grid",d.join(""))}function addToContent(c){var b=new Date();switchEnabled("#btn-loadmore",this.respInfo.more);this.target.append(c);if(c===false){this.target.append(listitemNull("沒有動態可顯示。"))}$("#main-loading").empty();setShow("#main-loading","",true);registerListUtil(this.target).registerAll();var a=new Date();console.log("[addToContent/Render] "+(a-b)+"ms")}var VERSION_MAJOR="1.";var VERSION_MINOR="64";var VERSION_COUNT="";var LAST_MODIFY="2014/7/11";var LOCAL_TEST=(location.hostname=="localhost");var DEBUGGING_ENVIROMENT=(!location.hostname);var URL_PROXY=DEBUGGING_ENVIROMENT?"":(LOCAL_TEST?"proxy.php":"http://andy0130tw.qov.tw/proxy.php");var URL_USERDATA=DEBUGGING_ENVIROMENT?"":(LOCAL_TEST?"":"http://andy0130tw.qov.tw/userdata.php");var URL_LM="https://apollo.omcompany.com:5443/api/";var URL_IMAGE="https://apollo.omcompany.com:5443/image/";var URL_HST="http://lmadmin.learnmode.net/api/v1/";var URL_SEARCH="https://mercury.omcompany.com:5443/";var URL_BADGE_BASE="res/image/badge/";var SPLASH_OFF_DURATION=2500;var FX_VIEW_DURATION=1000;var FX_BRING_TOP_DURATION=400;var FX_POPOVER_SHOW_DELAY=200;var FX_POPOVER_HIDE_DELAY=1200;var FX_SHADOWBOX_FADE_DURATION=0.25;var FX_SHADOWBOX_RESIZE_DURATION=0.3;var SHADOWBOX_DEFAULT_OPTION={skipSetup:true,viewportPadding:24,displayNav:false,resizeDuration:FX_SHADOWBOX_RESIZE_DURATION,fadeDuration:FX_SHADOWBOX_FADE_DURATION,initialHeight:120,initialWidth:120,overlayOpacity:0.3};var OLDEST_TIMESTAMP="T0001F681040000";var NOTIFY_TIME={SHORT:3000,MEDIUM:7000,LONG:10000};var YOUTUBE_REGEX=/v=([\w\-]*).*/i;var COUNT={HOMEPAGE:40,NOTIFICATION:50,REPLY:25,HOT:100,ANNOUNCEMENT:10,USER:30,USER_SEARCH:20,USER_BADGE:10,MOOD:30,VOTER:30,ALBUM:24,PIN:3};var COLOR_CLASS={APPLICATION:"text-muted list-small",CATEGORY:"text-info item-title-secondary",SCHOOL:"text-muted list-small",VOTE:"fg-amber",EMOTION:"fg-pink",FOLLOW:"text-success",BADGE:"text-warning",VOTE_BD:"bd-amber",EMOTION_BD:"bd-pink",FOLLOW_BD:"bd-green",BADGE_BD:"bd-orange",UNKNOWN:"text-warning",RM_HINT:"text-warning action-reveal-rm",RM_REVEALED:"text-alert",LABEL_ACTIVE:"fg-cobalt",PARSE_ERROR:"text-alert",VOTE_BUTTON:{_common:"bg-hover-gray action-vote",up:"success",down:"warning",clear:"inverse"}};var TEXT_RETURN_ALT=" "+TAG("small","text-pilcrow",ICON("pilcrow"));var DUMMY_USER={badges:[],is_following:false,is_followed_by:false,is_blocked:false,is_blocked_by:false,id:"",uid:"",username:"",roles:[],name:"帳號已被刪除",image:"D768239C61B080F71F4807B27C2A39A10BB44FB00C89B0675144F6403B23B4E5",desc:"本帳號已被刪除，因此此處顯示的帳號資料是虛擬的。",class_name:"(未知)",followers_count:0,following_count:0,school:"(未知)",_is_dummy:true};var valueOrOriginal=function(a,b){return b[a]||a};var HASH={levelName:{novice:["初學者",1],progress:["大進步",2],self_learner:["自動自發",3],advancer:["加速前進",4],smart:["聰明狂人",5],enthusiast:["狂熱主義",6],senior:["資深學人",7],talent:["才能高超",8],innovator:["改革創新",9],researcher:["研究生",10],influencer:["影響家",11],motivator:["激勵領袖家",12],unbeatable:["所向無敵",13],master:["名家大師",14],guru:["權威人士",15],professor:["專家教授",16]},badgeName:{explorer:["探險家",["於Books應用程式中閱讀","一頁+10分|累計30頁+15分"],[1000,5000,15000]],scout:["影武者",["於YouTube中觀看在LM分享的影片","一部+10分|累計30部+15分"],[1000,5000,15000]],vanguard:["好學士",["於Practice應用程式中完成考試","一次考試+10分|成績高於90分+15分|累計3次+15分"],[1000,5000,15000]],upgrader:["助力士",["還不知道。","有賴活躍者提供。"],[500,3000,12000]],connector:["博學家",["於Books應用程式中新增註解","每則+3分"],[500,3000,12000]],generator:["學問星",["提出問題","每則+3分"],[1000,5000,12000]],trailblazer:["善答星",["回答問題","每題問題+2分"],[500,3000,12000]],validator:["讚讚星",["對回答進行評分","???"],[500,3000,12000]],apprentice:["實習生",["登入","每天+1分|同日登入不重複計算"],[30,80,200]],lodestar:["北極星",["被其他人關注","每人+1分|不重複計算，解關注不會減少"],[30,80,200]],visionary:["夢想家",["發表貼圖","每則+3分"],[200,1500,3000]],discoverer:["發現家",["發表貼文","每則+1分"],[500,4000,8000]],touchstone:["感動家",["甩表情","每個+1分"],[200,1500,3000]],catalyst:["催化劑",["對貼文或貼圖發表評論","每則+1分"],[200,1500,3000]]},badgeLevel:{bronze:"銅牌",silver:"銀牌",gold:"金牌"},mood:["","熱愛","喜歡","無評論","討厭","憤怒"],exception:{timeout:{txt:"連線逾時",fatal:true},abort:{txt:"連線被取消",fatal:true},error:{txt:"其他錯誤",fatal:true},parsererror:{txt:"資料解析失敗",fatal:true}},failureTranslation:{"cannot follow oneself":"不能關注自己","empty message":"訊息不能為空","invalid parameters":"參數無效",blocked:"已被封鎖，無法執行","record not exist":"此紀錄不存在"}};var SUBJECT_MAP={10001:"建築",10002:"城市設計",10003:"藝術",10004:"媒體藝術",10005:"世界藝術與文化/舞蹈",10006:"設計",10007:"攝影",20001:"商業經濟",20002:"產業組織",20003:"統計與經濟計量",20004:"核心財務",20005:"估值和投資",20006:"風險投資和資本市場",20007:"銀行和貨幣",20008:"會計",20009:"工商管理",20010:"市場營銷",20011:"創業研究",30001:"媒體",30002:"媒體製作",30003:"傳播學",30004:"廣播",30005:"公關",30006:"辯論",30007:"電影",40001:"航空航天工程",40002:"大氣，海洋和空間科學",40003:"化學工程",40004:"土木與環境工程",40005:"電氣工程",40006:"工業工程",40007:"材料科學",40008:"機械工程",40009:"造船學",40010:"核工程與放射科學",50001:"健康研究",50002:"病理生理學",50003:"醫藥學",50004:"基因組學",50005:"藥理學",50006:"神經學",50007:"內分泌學",50008:"血液學",50009:"胃腸學",50010:"分子科學",60001:"寫作技巧",60002:"英語語言文學",60003:"比較文學",60004:"中國文學",60005:"美國劇院和戲劇",60006:"詩",60007:"編劇",70001:"算術",70002:"代數基礎",70003:"代數",70004:"幾何",70005:"三角",70006:"機率",70007:"統計",70008:"微積分基礎",70009:"微積分",70010:"微分方程式",70011:"線性代數",80001:"通識教育",80002:"邏輯",80003:"哲學史",80004:"倫理學與價值理論",80005:"認識論",80006:"現象學",90001:"生物學",90002:"化學",90003:"有機化學",90004:"物理",90005:"宇宙學和天文學",90006:"計算機科學",90007:"地理",100001:"音樂教育",100002:"編曲",100003:"音樂劇",100004:"戲劇和戲曲",100005:"音樂理論",100006:"木管樂器",100007:"打擊樂器",100008:"聲樂方法",100009:"樂隊管理",100010:"銅管樂器",110001:"歷史研究",110002:"中東史",110003:"亞洲史",110004:"歐洲史",110005:"美國歷史",110006:"拉丁美洲歷史",110007:"史前研究",120001:"政治學",120002:"民主理論",120003:"農業法",120004:"憲制性法律",120005:"財政和金融法",120006:"國際法",120007:"勞動和社會法",120008:"政治理論",120009:"國際關係",120010:"比較政治學",130001:"個性學",130002:"發展心理學",130003:"認知心理學",130004:"社會心理學",130005:"健康心理學",130006:"Pavlovian過程",140001:"佛教",140002:"古蘭經",140003:"禪：歷史，文化與批判",140004:"猶太人的視覺文化",140005:"世界宗教：中東",150001:"社會學的原理和存在",150002:"社會學理論",150003:"犯罪學",150004:"社會學視角",150005:"個人行為",150006:"社會正義，多樣性，認同，和社區",150007:"性別社會學",150008:"服務學習",160001:"運動訓練",160002:"運動科學",160003:"體育教育",160004:"體育管理",160005:"臨床經驗",160006:"體育財經",170001:"教育與心理",170002:"人類發展",170003:"多元文化的社會基礎",170004:"掃盲發展",170005:"教學方法",180001:"中文",180002:"英語",180003:"日文",180004:"法文",180005:"德語",180006:"阿拉伯語",180007:"西班牙文"};var SUBJECT_CATEGORY_NAME=["藝術、設計","經濟","通訊","工程","醫學","文學","數學","哲學","科學","音樂與戲劇","歷史","法律與政治","心理學與社會科學","宗教","社會與文化","運動","教育","語言"];var randomTip=["隨機小提示全部重新寫過了！重新整理可以看到另一些提示喔。","LM Textbook 已經因版權的緣故終止服務了，哭哭。","Flyer內建的瀏覽器有時候會跑不出小圖示。舉例來說：["+ICON("database")+"]。","程式碼現在是破三千五百行、快四十萬字了，這是超長篇小說！","這個網頁常常在更新啊。懷疑是不是最新版的話，整個網頁重新整理一次就知道了。","用網頁版留言的附帶優惠，是計算機科學的等級會升級。","這網頁的圖標是 皮皮 用 InkScape 做的，詳見選單中的「關於...」。","網頁的英文字型叫做 Roboto，是 Android 4.0+ 的系統字體(之一)。","這網頁在Flyer預設瀏覽器的效能問題，一直是惡夢。","關注/解關注常常會很遲鈍，這是伺服器的問題，需要耐心等待。","想不到 Tips 了... 請常逛作者開發樓吧。","網頁版沒有將圖片裁切或縮小的功能，拍照前請先將解析度調低，比較容易成功，也方便其他使用者觀看。"];function experimental(a){var d=["share","question","scrapbook","comment","watch","tutor"];if(a==1){for(var b=0,e=d.length;b<e;b++){RENDER_ENG.category1[d[b]].reactFN=renderVoteButton}alert("強制玄奇樓已設置。網頁重新整理後會失效。")}else{if(a==2){postIfBlock(0,1)}else{if(a==3){postIfBlock(0,0)}else{if(a==6){slient(function(){experimental(1)});window.EXPRI_ALL_IS_RELATED=true;REPLY_PRESET.comment={category:"comment",application:"reading LMClient",mood:true,allowImage:true};alert("究極玄奇樓已設置(含有強制玄奇樓內的所有效果)。網頁重新整理後會失效。")}else{alert("無效的實驗功能！")}}}}return false}function slient(b){var a=alert;alert=function(){};b.call(this);alert=a}function reloadWithReversed(a){if(a===undefined||a){viewLoadMerge({before:null,after:OLDEST_TIMESTAMP},1)}else{viewLoadMerge({after:null},1)}}function convertToLMTimeStamp(e){var f=new Date(e);var a=["Seconds","Minutes","Hours","Date","Month","FullYear"];var b=0;for(var c=0;c<6;c++){var g=f["getUTC"+a[c]]();if(c==4){g++}b+=g*Math.pow(64,c)}return"T000"+b.toString(16).toUpperCase()}function overrideAJAX(){$.ajaxPrefilter(function(a,c,b){c._error=c.error;a.error=function(d,f,e){if(c._autoRetry){console.log("[overrideAJAX] AutoRetry, option:",c);$.ajax(c)}else{if(c._error){c._error(d,f,e)}}}})}function loadFromLM(d,c,e,a,b){c=c||{};if(!c.device){c.device=storageObject.load("mac")}return $.ajax({url:urlParam(URL_LM+d,c),dataType:"jsonp",timeout:40000,success:function(f){if(f.status=="ok"){e(f)}else{if(a){a(f.message)}var g=valueOrOriginal(f.message,HASH.failureTranslation);notify.connectFailure("載入資料失敗 from LM!<br/>訊息: *** "+g+" ***")}},error:function(g,h,f){if(h=="abort"){notify.abort("嘗試重新整理中...",3000);return}notify.connectFailure("無法與 LM 連線!<br/>錯誤訊息: "+HASH.exception[h].txt)},_autoRetry:b})}function loadFromProxy(b,a,c){if(!URL_PROXY){notify.verbose("目前環境下無法使用 Proxy.<br/>視為請求成功。");c(null);return}a.action=b;return $.ajax({url:urlParam(URL_PROXY,a),data:a,timeout:50000,success:function(d){if(d.status.http_code=="200"){c(d.contents)}else{notify.error("載入資料失敗 from Proxy!<br/>資料無效.")}},error:function(e,f,d){if(f=="parsererror"){return}if(f.fatal){notify.connectFailure("無法與 Proxy 連線!<br/>錯誤訊息："+HASH.exception[f].txt)}}})}function postProxy(b,a,c){if(!URL_PROXY){notify.verbose("目前環境下無法使用 Proxy.<br/>視為請求成功.");c(null);return}a=a||{};return $.ajax({url:urlParam(URL_PROXY,{action:b}),type:"POST",data:a,processData:false,contentType:false,success:function(g){if(g.status.http_code==200){var f=g.contents;var d=f.indexOf("\r\n\r\n")+4;var e=f.lastIndexOf("}")+1;resp_obj=JSON.parse(f.substring(d,e));resp_obj._status=g.status;console.log("Post Success: ",resp_obj);if(resp_obj.status=="error"){var h=valueOrOriginal(resp_obj.message,HASH.failureTranslation);notify.error("POST 已成功執行, 但是結果似乎不對.<br/>訊息:<br/>"+h)}else{c(resp_obj)}}else{var f=g.contents.replaceAll("|","<br/>");notify.error("POST 執行失敗!<br/>HTTP Code: "+g.status.http_code+"<br/>訊息:<br/>"+f)}},error:function(e,f,d){if(f.fatal){notify.connectFailure("POST 至 LM 失敗!<br/>錯誤訊息: "+HASH.exception[f].txt)}}})}function loadUserdata(b,a,c){if(!URL_USERDATA){notify.verbose("目前環境下無法使用 Userdata.<br/>視為請求成功.");c(null);return}a=a||{};a.action=b;if(!a.mac){a.mac=storageObject.load("mac")}return $.ajax({url:urlParam(URL_USERDATA,a),timeout:40000,success:function(d){if(d.status.http_code==200){c(d.content)}else{notify.connectFailure("載入資料失敗 from Userdata!<br/>資料無效: "+d.content)}},error:function(e,f,d){notify.connectFailure("無法與 Userdata 連線!<br/>錯誤訊息: "+HASH.exception[f].txt)}})}function postUserdata(c,b,d){if(!URL_USERDATA){notify.verbose("目前環境下無法使用 Userdata.<br/>視為請求成功.");d(null);return}var a={action:c,mac:storageObject.load("mac")};b=b||{};return $.ajax({url:urlParam(URL_USERDATA,a),type:"POST",data:b,processData:false,contentType:false,success:function(f){if(f.status.http_code==200){var e=f.content;if(f.status=="ERROR"){notify.error("POST 已成功執行, 但是結果似乎不對.<br/>Message: "+e)}d(f)}else{notify.error("Post Failed!<br/>HTTP Code: "+f.status.http_code+"<br/>Message: "+f)}},error:function(f,g,e){if(g.fatal){notify.connectFailure("POST 至 LM 失敗!<br/>錯誤訊息: "+HASH.exception[g].txt)}}})}var dummyContent;var lastestEntryID="";var lastestAnnouncementID="";var usersMoreFN=function(){};var lastestUsersID="";var SUBJECT=[];var userProfile;var currentProfile;function readProfile(a){loadFromLM("profile/read",a,doLogin,doLoginFailure)}function readUserProfile(a){assert(a.user,"readUserProfile","id is missing.");loadFromLM("profile/read",a,function(b){userProfile=b.profile;addToUserLightbox()})}function listAnnouncement(b,a){if(a){$("#announcement-body").empty()}$("#announcement-loading").html(getLoadingRing("center"));setShow("#announcement-loading","",false);loadFromLM("announcement/list",b,addToAnnouncementPopup);return b}function getDetailedPost(a,b){if(b){loadFromLM("read",a,parseMood)}else{$("#reply-loading").html(getLoadingRing()+"載入中…");setShow("#reply-loading","#reply-ok",false);$("#reply-sub-loading").html(getLoadingRing("center"));setShow("#reply-sub-loading","#reply-sub-ok",false);loadFromLM("read",a,parseReply);getDetailedMood({id:a.id,count:COUNT.MOOD})}}function getDetailedMood(a){detailedMood=[];switchClass(".moodlightbox","success",false);switchEnabled(".moodlightbox",false);loadFromLM("mood/list",a,parseDetailedMood)}function getRelated(b){$("#reply-content-loading").html(getLoadingRing("center"));setShow("#reply-content-loading","",false);assert(b.id,"getRelated","The request might be unsent.");var c={};for(var a in b){if(a=="id"){c.related=b.id}else{c[a]=b[a]}}c.sort=c.sort||replyObject._sort;assert(c.sort,"getRelated","Sort not given.");c.count=COUNT.REPLY;loadFromLM("list",c,addToReplyPopup)}function getVoter(a){loadFromLM("vote/list",a,function(e){voter=new Array(2);voter[0]=[];voter[1]=[];for(var b in e.list){var d=e.list[b];var c=e.users[d.user]||DUMMY_USER;c._vote_date=d.date;if(d.vote=="up"){voter[0].push(c)}else{if(d.vote=="down"){voter[1].push(c)}}}addToVoterLightbox()})}function getPinList(){loadUserdata("load",{},initPinList)}function refreshReply(){clrReplyPopup();replyObject._newest=undefined;replyObject._sort="date";replyObject._user_filter=null;getRelated({id:replyObject.id})}function sortReplyByScore(){clrReplyPopup();replyObject._newest=undefined;replyObject._sort="score";replyObject._user_filter=null;getRelated({id:replyObject.id})}function sortReplyReverse(){clrReplyPopup();replyObject._newest=undefined;replyObject._sort="subject";replyObject._user_filter=null;getRelated({id:replyObject.id})}function seekReplyByPerson(){clrReplyPopup();replyObject._user_filter=$(this).data("user");getRelated({id:replyObject.id,user:replyObject._user_filter})}var REPLY_PRESET={share:{category:"comment",application:"reading",mood:true,allowImage:true},question:{category:"answer",application:"reading",mood:false,allowImage:true},scrapbook:{category:"comment",application:"scrapbook",mood:true,allowImage:false},watch:{mood:true,none:true},_none:{category:undefined,application:undefined,mood:false,allowImage:false,none:true},comment:{mood:false,hideSender:true}};function modifyObj(d,b,c){if(!d){return null}if(c=="announcement"){d._user=b.users[d.uid]||DUMMY_USER}else{d._user=b.users[d.from]||DUMMY_USER}if(b.related){d._related=d.related?b.related[d.related]:null;d._related_user=d.related?b.users[d._related.from]||DUMMY_USER:null}if(typeof EXPRI_ALL_IS_RELATED!="undefined"&&d.id!="00"){d.related=d.id;d._related=d;d._related_user=b.users[d.from]||DUMMY_USER}correctCheatCategory(d);if(d.voters){for(var a=0;a<d.voters.length;++a){d.voters[a]=b.users[d.voters[a]]||DUMMY_USER}}return d}function correctCheatCategory(a){if(a.category=="annotation"&&!isNaN(a.url)){a.category="practice";return true}return false}function addToAnnouncementPopup(f){var b=f.list;lastestAnnouncementID=f.info.oldest;switchEnabled("#btn-loadmore-announcement",f.info.more);var d=$("#announcement-body"),c="";for(var a in b){var e=modifyObj(b[a],f,"announcement");c+=renderAnnouncement(e)}d.append(c);setShow("#announcement-loading","",true);registerListUtil(d).registerAll()}function addToUsersPopup(g){setShow("#users-loading","#users-ok",true);var c=g.list,e=g.users;usersMoreFN._param=usersMoreFN._param||{};usersMoreFN._param.before=g.info.oldest;switchEnabled("#btn-loadmore-users",g.info.more);var f=$("#users-body");if(e.length==0){f.append(listitemNull("查無結果..."))}var d="";for(var a in c){var b=e[c[a].user]||DUMMY_USER;b._badge=c[a].badge;b._subject=c[a].subject;b._date=c[a].date;d+=renderUserListView(b)}$("#users-body").append(d);registerListUtil(f.parent()).registerAll();$("#users-body-loading").empty();setShow("#users-body-loading","",true)}function addToReplyPopup(h){var d=h.list;replyObject._oldest=h.info.oldest;if(!replyObject._newest){replyObject._newest=h.info.newest}var b=0;if(h.list[0]){var f=h.list[0].related;if(pinList&&pinList[f]&&pinList[f].unread){console.log("[addToReplyPopup] cleared");clearUnread(f);postSavePinList()}b=h.related[f].ref_count}$("#reply-ok .panel-title > div").children("span").eq(1).html(b);switchEnabled("#btn-loadmore-reply",h.info.more);if(d.length==0){$("#reply-content").html(listitemNull("還沒有回應。"))}var e="";for(var c in d){var g=modifyObj(d[c],h);e+=renderPostListView(g,true)}$("#reply-content").append(e);finishReplyPopup()}function finishReplyPopup(){registerListUtil("#reply-sub-ok").registerAll();setShow("#reply-sub-loading","#reply-sub-ok",true);$("#reply-content-loading").empty();setShow("#reply-content-loading","",true);checkPinPostButton()}var replyObject={};function parseMood(d){d=modifyObj(d.list[0],d);for(var b=0;b<6;++b){var c=$("#reply-mood button");var a=c.children("small").eq(b);switchClass(c.eq(b),"inverse",(b==d.my_mood-1||(b==5&&d.my_mood==0)));if(b<5){a.html(d.moods[b])}}setShow("#reply-loading","#reply-ok",true)}function parseDetailedMood(e){detailedMood=new Array(5);for(var c=0;c<5;++c){detailedMood[c]=[]}for(var a in e.list){var d=e.list[a];var b=e.users[d.user]||DUMMY_USER;if(b){b._mood_date=d.date;if(d.mood>0){detailedMood[d.mood-1].push(b)}}}switchClass(".moodlightbox","success",true);switchEnabled(".moodlightbox",true)}function parseReply(b){replyObject=modifyObj(b.list[0],b);replyObject._sort="date";var a=$("#reply-body");a.html(renderCompactPost(replyObject));registerListUtil(a).registerAll();parseMood(b);var c=REPLY_PRESET[replyObject.category]||REPLY_PRESET._none;switchVisible("#reply-tool,#reply-content,#reply-bottom",!c.none);switchVisible("#reply-accordion",!c.none&&!c.hideSender);switchVisible("#reply-mood,.moodlightbox",c.mood);switchVisible("#postreply-file-uploader",c.allowImage);replyObject._replyBase=c;if(!c.none){getRelated({id:b.list[0].id})}else{finishReplyPopup()}}var badgeObj={};function addToAward(m){switchEnabled("#btn-loadmore",false);var j=[];var a=[],d={};var s=0;badgeObj={};var k=$("#mainContent");for(var l in m){var e=m[l];if(isLevel(e.badge)){var r=HASH.levelName[e.badge];var g=e.subject;var p=SUBJECT_MAP[e.subject];if(typeof e.subject=="string"){g+="@@@";p=TAG("span","fg-emerald",ICON("film"))+" "+p}else{p=TAG("span","fg-indigo",ICON("feed"))+" "+p}var o=d[g];if(!o||r[1]>=o[1]){d[g]=[p,r[1],"",r[0],e.date]}}else{var h=e.badge.split("_");var t=h[0]+e.subject;var q=badgeObj[t];s++;badgeObj[t]=badgeObj[t]||[];badgeObj[t].push(e)}}for(var l in badgeObj){badgeObj[l].sort(function(u,i){return compareBadgeLevel(u.badge.split("_")[1],i.badge.split("_")[1])});j.push(renderAward(badgeObj[l][badgeObj[l].length-1]))}var f=processGrid(j,4);k.append(TAG("h2","獎牌 "+TAG("small","x"+s+" (只會顯示最高位階)"))+TAG("div","grid fluid",f.join("")));for(var l in d){a.push(d[l])}a.sort(function(u,i){return new Date(i[4])-new Date(u[4])});for(var n=0;n<a.length;++n){a[n][2]=repeatStr("|",a[n][1])+repeatStr(TAG("span","fg-grayLighter","|"),16-a[n][1]);a[n][4]=dateConverter(a[n][4],true)}var c=["科目","等級","","等級名稱","獲得日期"];k.append(TAG("h2","等級"+TAG("small"," x"+a.length))+TAG("table","table fill-level hovered",TABLE_HEADER(c)+TABLE(a)));registerListUtil(k).registerTimeAgo()}function repeatStr(b,d){var c="";for(var a=0;a<d;a++){c+=b}return c}function clrReplyPopup(a){if(a){$("#reply-body").empty()}$("#reply-content").empty();replyObject._oldest="";switchEnabled("#btn-loadmore-reply",false)}function clrUsersPopup(){$("#users-body").empty();usersMoreFN._param=null;switchEnabled("#btn-loadmore-users",false)}
/*!
Copyright:
Code related to formData was modified from ggt.tw
See: ggt.tw/learnmode
*/
;function postShareForm(){var f=new FormData();var g=$("#postshare-file-image")[0];var e="com.htc.learnmode";var b=$("#postshare-category").val();var a=String($("#postshare-url").val());var d=$("#postshare-message").val();if(!d&&confirm("要清空圖片欄位嗎？")){$("#postshare-form")[0].reset();return}var j=function(){f.append("url",a);j=null};if(b=="scrapbook"){if(!g.files[0]){alert("剪貼簿必須要有圖片才可發佈。");return}if(a){j();e="com.android.browser"}}else{if(b=="watch"){if(!a){alert("觀看影片必須要有影片網址，且目前只支援YouTube。");return}else{var k="",i=YOUTUBE_REGEX.exec(a);if(i){k=i[1]}else{var h=a.split("/");k=h[h.length-1];var m=confirm("偵測到影片的ID為[ "+k+" ]，正確嗎？");if(!m){return}}f.append("title",d.split("\n")[0]);a="http://m.youtube.com/#/watch?v="+k;j()}e="browser"}}f.append("device",storageObject.load("mac"));f.append("message",$("#postshare-message").val());f.append("application",e);f.append("category",b);var l=$(".postshare-subject option:selected").map(function(){return this.value}).get();if(!l.length){if(b=="watch"){l=[10001,10004,30007]}}f=appendSubject(f,l);if(g.files&&g.files[0]){f.append("image",g.files[0])}setShow("#postshare-ok","#postshare-processing",true);postProxy("postNotify",f,function(c){modalHide();notify.complete({message:"貼文發佈成功！",status:c?c._status:{}});$("#postshare-form")[0].reset();postshareCategoryChange();changeSubjectSelection();$("#btn-refresh").click()})}function postReplyForm(){var c=$("#postreply-message").val();if(!c&&confirm("要清空圖片欄位嗎？")){$("#postreply-form")[0].reset();return}$("#popup-reply-accordion-content").collapse("hide");var b=new FormData();b.append("device",storageObject.load("mac"));b.append("message",c);b.append("category",replyObject._replyBase.category);b.append("application",replyObject._replyBase.application);b.append("related",replyObject.id);b=appendSubject(b,extractSubject(replyObject.subjects));var a=$("#postreply-file-image")[0];if(a.files&&a.files[0]){if(replyObject._replyBase.allowImage){b.append("image",a.files[0])}}postProxy("postNotify",b,function(d){notify.complete({message:"回應發佈成功！",status:d._status});$("#postreply-form")[0].reset();refreshReply()})}function appendSubject(c,a){for(var b=0;b<a.length;++b){c.append("subject[]",a[b])}return c}function postMood(a){var b=new FormData();b.append("device",storageObject.load("mac"));b.append("mood",a);b.append("id",replyObject.id);postProxy("postMood",b,function(d){var c=d.message=="0"?"清除表情或未變動":("甩了一個 [ "+HASH.mood[d.message]+" ]");notify.info(c+"！");getDetailedPost({id:replyObject.id},true)})}function postVote(b,d,c){assert(d,"postVote","id is missing.");var a=new FormData();a.append("device",storageObject.load("mac"));a.append("vote",b);a.append("id",d);postProxy("postVote",a,function(g){var e=g.message;var f={up:ICON("thumbs-up"),down:ICON("thumbs-down"),clear:"清除評分"};notify.info("評了一個"+f[e]+"！<br/>評分分數要重新整理後才會更新。");c(g)})}function postIfFollow(a,b){var c=new FormData();c.append("device",storageObject.load("mac"));c.append("user",a);if(b){postFollow(c,a)}else{postUnfollow(c,a)}}function postFollow(b,a){postProxy("followUser",b,function(c){notify.info("成功關注！");readUserProfile({user:a})})}function postUnfollow(b,a){postProxy("unfollowUser",b,function(c){notify.info("成功解除關注！");readUserProfile({user:a})})}function BLOCK_CAUTION_MAKER(b,c){if(typeof c=="undefined"){alert("Syntax: postIfBlock(a,b), \n a is ignored, and b is your decision.");return false}var a="這是一個本網頁的實驗功能，\n可以利用這個函式來封鎖/解除封鎖某人。\n進入該人的大聲公之後呼叫此函式即可。\n\n";if(isMyself(b)){alert(a+"你想對你自己做什麼？");return false}return confirm(a+"你想要"+(c?"":"解除")+"封鎖 "+b.name+" 嗎？")}function postIfBlock(a,c){if(!BLOCK_CAUTION_MAKER(currentProfile,c)){return}var d=new FormData();var b=currentProfile.username;d.append("device",storageObject.load("mac"));d.append("user",b);(c?postBlock:postUnblock)(d,b)}function postBlock(b,a){postProxy("blockUser",b,function(c){notify.info("成功封鎖！");readUserProfile({user:a})})}function postUnblock(b,a){postProxy("unblockUser",b,function(c){notify.info("成功解除封鎖！");readUserProfile({user:a})})}function postSavePinList(){var c=new FormData();var b={};for(var a in pinList){if(pinList[a]){b[a]=pinList[a]}}pinList=b;c.append("data",JSON.stringify(pinList));postUserdata("save",c,function(d){if(d){console.log("[postSavePinList] sync status="+d.content)}})}var RENDER_ENG={category1:{share:{label:"愛分享",label_alt:"貼文",base:"分享了一篇#貼文#。",buttonLabel:"評論",scoreFN:renderScore,contentFN:renderContent,reactFN:NULL},question:{label:"大哉問",label_alt:"問題",base:"提出了一個#問題#。",buttonLabel:"回答",scoreFN:renderScore,contentFN:renderContent,reactFN:NULL},scrapbook:{label:"剪貼簿",label_alt:"貼圖",base:"在剪貼簿上新增一則#貼圖#。",buttonLabel:"評論",scoreFN:renderScore,contentFN:renderContent,reactFN:NULL},comment:{label:"評論",base:"回應了%%%的#&&&#。",base_norel:"發表了#回應#。",buttonLabel:"觀看",scoreFN:NULL,contentFN:renderContent,reactFN:NULL},answer:{label:"回答",base:"回答了%%%所提的#&&&#。",base_norel:"發表了#回答#。",buttonLabel:"觀看",scoreFN:renderVote,contentFN:renderContent,reactFN:renderVoteButton},course:{label:"課程",base:"在#Course#上",base_fallback:"在#Course#上的動態。",buttonLabel:"讀取",scoreFN:NULL,contentFN:renderContent,reactFN:NULL},annotation:{label:"Textbook/Practice",base:"在#Textbook#上新增了一則註解。",buttonLabel:"讀取",scoreFN:NULL,contentFN:renderContent,reactFN:NULL},practice:{label:"Practice",base:"在#Practice#上",base_fallback:"在#Practice#上的動態。",buttonLabel:"讀取",scoreFN:NULL,contentFN:renderContent,reactFN:NULL},tutor:{label:"講座",base:"分享了一篇#講座#(已廢棄，只有早期貼文會出現)",scoreFN:renderScore,buttonLabel:"評論",contentFN:renderContent,reactFN:NULL},watch:{label:"觀看影片",label_alt:"影片",base:"看了一部#影片#。",scoreFN:NULL,buttonLabel:"讀取",contentFN:renderWatch,reactFN:NULL}},category2:{"!follow":{label:"關注",scoreFN:NULL,buttonLabel:"",contentFN:NULL,reactFN:NULL},"!emotion":{label:"甩表情",scoreFN:NULL,buttonLabel:"觀看",contentFN:NULL,reactFN:NULL},"!badge":{label:"等級/獎牌",scoreFN:NULL,buttonLabel:"",contentFN:renderBadgeImage,reactFN:NULL},"!vote":{label:"評分",scoreFN:NULL,buttonLabel:"觀看",contentFN:NULL,reactFN:NULL},watch:null}};function renderPost(d,a){try{var j="",h={};var c=d._user;if(d.category===undefined){return""}var k=!a;if(a&&replyObject&&replyObject.id!=d.id&&d.ref_count>0){k=true}var b=["share","question","scrapbook"].indexOf(d.category)>=0;var g=matchAltContent(d,a);if(h=RENDER_ENG.category1[d.category]){var f=h.scoreFN;if(d.voters.length&&f==NULL){f=renderVote}j=(k?renderButton(d,h.buttonLabel):"")+f(d)+h.reactFN(d)+renderAvatar(c)+renderUser(d)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,c.school)+"&nbsp;"+(!a?renderAbstract(d,g):"")+(a&&b?TAG("span",COLOR_CLASS.CATEGORY,"&nbsp;"+(h.label)):"")+renderApplication(d)+"<br/>"+TAG("span","list-datetime",renderSSTitle(d))+renderVotersRaw(d)+h.contentFN(d,g)+renderURI(d)+(d.image?TAGi(d.image):"")}else{if(h=RENDER_ENG.category2[d.category]){j=(k?renderButton(d,h.buttonLabel):"")+h.reactFN(d)+renderAvatar(c)+renderUser(d)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,c.school)+"&nbsp;"+TAG("span",compactMsg(d))+"<br/>"+TAG("span","list-datetime",dateConverter(d.date,true))+"<br/>"+h.contentFN(d)+renderURI(d)}else{j=(k?renderButton(d,""):"")+renderScore(d)+renderAvatar(c)+renderUser(d)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,c.school)+TAG("span","text-muted list-small"," @ "+(d.application||"---"))+TAG("span","text-info list-small","&nbsp;&nbsp;&nbsp;"+("?: "+d.category))+"<br/>"+TAG("span","list-datetime",dateConverter(d.date,true))+"<br/>"+TAG("span","list-title text-alert","UNKNOWN CATEGORY:"+d.category+". Raw JSON dump:")+TAG("span","list-remark",JSON.stringify(d))}}return j}catch(i){notify.warning('有貼文無法正確排版! <br/>請截圖貼到 "功能表->作者開發樓" 協助回報這個錯誤, 謝謝! <br/>'+i.toString());console.log("[renderPost] render failure, obj: ",d," e:",i);return TAG("p",COLOR_CLASS.PARSE_ERROR,"ERROR occured in renderPost: "+i.toString())+d}}function renderPinPost(d){try{var b="",a=d._user;d.message=truncateText(d.message.replaceAll("\n"," "),70);b=renderButton(d,"詳細")+TAG("span","label fill-count place-right","...")+renderAvatar(a)+renderUser(d)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,a.school)+"&nbsp;："+renderApplication(d)+"<br/>"+TAG("span","list-datetime",renderSSTitle(d))+renderContent(d)+(d.image?TAGi(d.image,60):"");return b}catch(c){notify.warning('追蹤列表無法正確排版! <br/>請截圖貼到 "功能表->作者開發樓" 協助回報這個錯誤, 謝謝! <br/>'+c.toString());return TAG("p","text-warning","ERROR occured in renderPost: "+c.toString())+d}}function renderPinPostReply(c){var b="",a=c._user;c.message=truncateText(c.message.replaceAll("\n"," "),20);b=renderAvatar(a,"inline")+renderUser(c)+"&nbsp;"+TAG("span","text-muted list-small",a.school)+"："+c.message;return b}function renderAnnouncement(c){var a=c._user;var b=renderAvatar(a)+renderUser(c)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,a.school)+"<br/>"+TAG("span","list-datetime",dateConverter(c.date,true))+"<br/>"+renderContent(c)+(c.image?TAGi(c.image):"")+renderURI(c);return listitem(b)}function renderCompactPost(a){return renderPostListView(a,true)}function renderWatch(e){var d=YOUTUBE_REGEX.exec(e.url);var b=d?("http://www.youtube.com/embed/"+d[1]+"?autoplay=1&rel=0"):e.url;var a=e.message.split("\n");var f=a.shift();var c=a.join("\n");return TAG("span","list-title",TAG("p",f)+processContent(c)+"<br/>"+TAG("blockquote","",ICON("right-quote")+" 影片："+LINK(b,e.title)))}function renderUser(a){return renderUserRaw(a._user)}function renderUserRaw(c,e){var d=c.name;if(e){e=e.replace("%%%",d)}var b=c._is_dummy?"text-warning":"userlightbox";var a=c._is_dummy?"":"data-id='"+c.username+"'";if(c.roles[0]=="teacher"){b+=" bd-indigo";a+=" style='border:3px dotted;'"}return TAG("strong",b,a,e||d)}function renderAvatar(b,a){a=a||"";if(!b._is_dummy){a+=" userlightbox"}return renderAvatarRaw(b,"icon shadow"+(a?" "+a:""))}function renderAvatarRaw(b,a){var c=imageLM(b.image);var d=b.username;return TAG("img",a,"src='"+c+"' data-id='"+d+"'","")}function renderVoteButton(b){var a=COLOR_CLASS.VOTE_BUTTON;class1=b.my_vote=="up"?{sty:a.up,func:"clear"}:{sty:a.clear,func:"up"};class2=b.my_vote=="down"?{sty:a.down,func:"clear"}:{sty:a.clear,func:"down"};return TAG("div","vote-container place-right",renderButtonRaw(ICON("thumbs-up"),a._common+" "+class1.sty,{func:class1.func,id:b.id,role:"up"})+renderButtonRaw(ICON("thumbs-down"),a._common+" "+class2.sty,{func:class2.func,id:b.id,role:"down"}))}function NULL(){return""}function renderApplication(a){if(a.category!="scrapbook"){return""}return TAG("span",COLOR_CLASS.APPLICATION," @ "+(a.application))}function renderContent(d,c){var a=processContent(d.message);if(c){a=processContent(c.further);if(c.isCompact){a=c.content+"<br/>"+a}}var b="list-title";if(d.flagged){return TAG("strong",b+" "+COLOR_CLASS.RM_HINT,"data-rm='"+d.id+"'",ICON("blocked")+" Removed by Moderator，點此觀看。")}if(d.message=="　"||d.message==" "){b+=" empty"}if(d._flagged){b+=" "+COLOR_CLASS.RM_REVEALED;a=ICON("unlocked")+" <strong>[RM Revealed!]</strong><br/>"+a}return TAG("span",b,a)}function matchAltContent(f,b){var d=f.message.replaceAll("_"," ");var j=RENDER_ENG.category1[f.category];var k={content:"",further:"",isCompact:b};if(f.category=="course"){var i=/^(對|对)(.*)(課程的評分為|课程的评分为)(.+)/;var g=/^(對|对)(.*)(課程，有以下的意見|课程，有以下的意见),'([\s\S]+)'/;var a=false;if(d.match(i)){d=d.replace(i,"$1"+TAG("strong"," $2 ")+"$3"+TAG("strong"," $4 "));a=true}else{if(d.match(g)){d=d.replace(g,function(l,r,o,n,m,q,p){k.further=m;return r+TAG("strong"," "+o+" ")+n+"："});a=true}}if(!a){console.log("[renderContent] Try to match the content of category but failed.",d);return k}k.content=d;return k}else{if(f.category=="practice"){var h="$1"+TAG("strong"," $2 ")+"$3";var e=/^(考完)(.+)(的試卷|的试卷)/;d=d.replace(e,h);var c=/(,獲得|获得)(.+)(分)$/;d=d.replace(c,h);k.content=d;return k}}return false}function renderURI(h){var d=h.url;if(!d||d.match(/:\/\/$/)||h.category=="watch"){return""}if(d.indexOf("course:")==0){var g=d.match(/id=(.+)&chapterId=(.+)/);if(!g){return""}var b="http://course.learnmode.net/upload/video_"+g[2]+".mp4?direct=1";return TAG("blockquote",ICON("camera-2")+" Course 課程影片："+LINK(b,"Course #"+g[2]+" (ID="+g[1]+")"))}else{if(d.indexOf("textbook:")==0){var f=d.match(/textbook:discussion=(.+)&page=(.+)/);if(!f){return""}f[2]++;var a="http://textbook01.learnmode.net/upload/"+f[1]+".pdf?direct=1#page="+f[2];return TAG("blockquote",ICON("book")+" Books 書籍PDF："+LINK(a,"Books #"+f[1]+" (第 "+f[2]+" 頁)"))}else{if(d.indexOf("content://")==0){var e=d.match(/com.htc.learnmode\/(.+)\/(.+)/);if(!e){return""}return TAG("blockquote",ICON("tag")+" 跳至貼文："+TAG("span","action-reply text-info pseudolink","data-id='"+e[2]+"'",RENDER_ENG.category1[e[1]].label+" ["+postIdTruncate(e[2])+"]"))}else{if(h.category=="practice"){var c=d;d="http://practice.learnmode.net/upload/"+d+"/test_"+d+"_info.zip";return TAG("blockquote",ICON("calculate")+" Practice試題(測試)："+LINK(d,"Exam Archive #"+c))}else{if(d.indexOf("http")==0){return TAG("blockquote",ICON("right-quote")+" 網頁："+LINK(d))}}}}}return TAG("blockquote",d+" (Can't be interpreted yet)")}function renderSubject(f,c){var b=[],a=f.subjects.length,e;for(var d=0;d<a;++d){b.push(SUBJECT_MAP[f.subjects[d].id]);if(d+1==c&&a-b.length>1){b.push("…("+(a-b.length)+")");e=true;break}}b._trimmed=!!e;return b}function renderPostListView(b,c){var a="";if(b.category=="!follow"){a={inner:COLOR_CLASS.FOLLOW_BD,outer:"follow-outer"}}else{if(b.category=="!emotion"){a={inner:COLOR_CLASS.EMOTION_BD,outer:"emotion-outer"}}else{if(b.category=="!vote"){a={inner:COLOR_CLASS.VOTE_BD,outer:"vote-outer"}}else{if(b.category=="!badge"){a={inner:COLOR_CLASS.BADGE_BD,outer:"badge-outer"}}}}}return listitem(renderPost(b,c),!c,a)}function renderPinPostInner(a){return TAG("div","list-content",renderPinPost(a))}function renderPostImageView(a){return thumbitem(imageLM(a.image,"l"),"action-reply span3",TAG("div","overlay-fluid",a.message),a.id)}function renderAward(a){var b=SUBJECT_MAP[a.subject];return thumbitem(BADGE(a.badge),"bg-white action-award span3",TAG("div","text-center item-title",badgeTranslate(a.badge))+(b?TAG("div","text-center text-muted",TAG("small",b)):"")+TAG("div","text-center fg-lightBlue item-title-secondary",dateConverter(a.date,true)),a.badge.split("_")[0]+a.subject)}function renderUserListView(a){var e=processContent(a.desc);var d=getRelationWithUser(a);var b=SUBJECT_MAP[a._subject];var c=renderAvatar(a)+renderUserRaw(a,"%%% ("+a.username+")")+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,a.school+"/"+a.class_name)+"&nbsp;"+TAG("span","text-muted place-right",TAG("span",a.is_followed_by?COLOR_CLASS.LABEL_ACTIVE:"",ICON("pop-out")+a.following_count)+"‧"+TAG("span",a.is_following?COLOR_CLASS.LABEL_ACTIVE:"",ICON("pop-in")+a.followers_count)+"<br/>"+(d||""))+(a._date?"<br/>"+TAG("span","list-datetime",(dateConverter(a._date,true))+(b?", "+TAG("span","text-success",b):"")):"")+TAG("pre","list-subtitle",e);return listitem(c)}function renderButton(b,a){if(b.id=="00"&&!b.related){return""}if(!a){return""}if(b.flagged){a=ICON("locked-2")+" "+a}var c=b.related||b.id;if(b.ref_count>0){c=b.id}if(b.category=="!vote"&&b._related.category=="answer"){c=b._related.related||null}if(!c){return""}return renderButtonRaw(a,"large primary place-right action-reply",c)}function renderSeekButton(c){var a="place-right small action-seek-this-person";var b={user:c._user.uid};if(replyObject._user_filter){a+=" primary";b={}}else{a+=" link"}return renderButtonRaw("*",a,b)}function renderButtonRaw(e,d,g,f){if(!g){return""}var c={};c=(typeof g=="string")?{id:g}:g;var b="";for(var a in c){b+="data-"+a+"='"+c[a]+"' "}return TAG(f||"button",d,b,e)}function renderScore(a){return renderScoreVoteRaw(a.score,"info")}function renderVote(b){var a=b.score>0?"success":"alert";return renderScoreVoteRaw(b.score,a)}function renderScoreVoteRaw(b,a){a="label place-right"+(b?" zoomin "+a:"");return TAG("span",a,b)}function renderAbstract(e,b){var c=RENDER_ENG.category1[e.category],a;var d=RENDER_ENG.category1[e.category].base;if(!e.related&&(a=c.base_norel)){d=a}var f=/#(.+?)#/;d=d.replace(f,TAG("span","text-info"," $1 "));if(b){return b.content?(d+b.content):c.base_fallback}if(d.indexOf("&&&")>=0){d=d.replace("&&&",renderPopLabel(e))}if(d.indexOf("%%%")<0){return d}return d.replace("%%%",TAG("strong",renderInlineName(e,true)))}function renderBadgeImage(b){if(HASH.levelName[b.badge]){return""}var a={};a.badge=b.badge;a.subject=b.subjects[0].id;a.date=b.date;return TAG("span","list-clearfix",TAGb(a))}function renderSSTitle(d){var c=dateConverter(d.date,true);var b=renderSubject(d,5);var a=b._trimmed?"title='"+renderSubject(d)+"'":"";c+=(needSubject(d.category)?TAG("span","text-muted",a," 科目："+b):"");return c}function renderVotersRaw(g){var h=[],c,b,a;var f=function(i){h.unshift(TAG("big","text-bold",i))};for(var d=0;d<g.voters.length;++d){var e=g.voters[d];if(isMyself(e)){c=true}else{if(isSameUser(e,g._user)){b=true}else{if(g._related_user&&isSameUser(e,g._related_user)){a=true}else{h.push(e.name)}}}}if(b){f("他自己")}if(c){f("你")}if(a){f("發問者")}return h.length?("<br/>"+TAG("span","text-muted place-right voterlightbox","data-id='"+g.id+"'","誰評分："+h.join(", "))):""}function compactMsg(d){var c=function(){return TAG("strong",renderInlineName(d))};var a=function(e){return TAG("span",e,renderPopLabel(d))};if(d.category=="!follow"){return"正在"+TAG("span",COLOR_CLASS.FOLLOW,"關注")+"你。"}else{if(d.category=="!badge"){if(isLevel(d.badge)){return"現在是 "+TAG("strong",SUBJECT_MAP[d.subjects[0].id])+"科 的 "+TAG("strong",badgeTranslate(d.badge))+" "+TAG("span",COLOR_CLASS.BADGE,"等級")+"！"}else{var b=SUBJECT_MAP[d.subjects[0].id];if(d.subjects[0].id==10001){b=false}return"榮獲了 "+(b?TAG("strong",b)+"科 的 ":"")+TAG("strong",badgeTranslate(d.badge))+" "+TAG("span",COLOR_CLASS.BADGE,"獎章")+"！"}}else{if(d.category=="!emotion"){if(d.message==0){return"清除/維持了他對"+c()+"的 "+a(COLOR_CLASS.EMOTION)+" 的"+TAG("strong",COLOR_CLASS.EMOTION,"表情")+"。"}return"給了"+TAG("strong",c())+"的 "+a(COLOR_CLASS.EMOTION)+" 一個 "+TAG("strong",COLOR_CLASS.EMOTION,HASH.mood[d.message])+" 表情！"}else{if(d.category=="!vote"){if(d.message=="clear"){return"清除了他對"+TAG("strong",c())+"的 "+a(COLOR_CLASS.VOTE)+" 的"+TAG("strong",COLOR_CLASS.VOTE,"評價")+"。"}return"給了"+TAG("strong",c())+"的 "+a(COLOR_CLASS.VOTE)+" 一個 "+TAG("strong",COLOR_CLASS.VOTE,d.message=="up"?(ICON("thumbs-up")+" 讚"):(ICON("thumbs-down")+" 遜"))+"！"}else{return"<Unknown Information>"}}}}}function renderInlineName(g,e){var f=g._related;var d=g._related_user;if(!d){console.log("[renderInlineName] The obj has been asked for its parent, but no reluser found.");return UNKNOWN()}var c=d.name;if(!c){return UNKNOWN()}if(f){var a=false;if(d.id==g.from){c="他自己"}else{if(isMyself(d)){c="你"}else{var b="";if(e){b=renderAvatarRaw(g._related_user,"inline-small userlightbox on-right-more")+" "}return b+" "+renderUserRaw(d)+" "}}}return c}function renderPopLabel(f){var c=f._related;if(!c){return UNKNOWN()}var d=RENDER_ENG.category1[c.category];var h=UNKNOWN();if(d){h=d.label_alt||d.label}var g=f._related?h:UNKNOWN();var b=(c.image?TAGi(c.image,80)+"<br/>":"");var a=normalize(truncateText(c.message,150)).replaceAll("\n",TEXT_RETURN_ALT);var e=b+a.replaceAll("'","&#39;");return frag="<span data-toggle='popover' data-placement='auto left' data-title='"+RENDER_ENG.category1[c.category].label+RENDER_ENG.category1[c.category].scoreFN(c)+"' data-content='"+e+"' class='pop-over'>"+g+"</span>"}USE_MOBILE_RULE=false;if(!console||!console.log){console={log:function(){}}}main();function main(){var b='<div class="loader-ring">';for(var a=0;a<5;a++){b+='<span class="circle"></span>'}b+="</div>";$("#_loadingState .loading").prepend(b);Shadowbox.init(SHADOWBOX_DEFAULT_OPTION);checkUseMobileRule();$(init)}function init(){try{if(FREEZE){return}if(typeof FastClick!="undefined"){FastClick.attach(document.body)}var b=new Date();$("a[href='#']").attr("href","javascript:void(0)");switchNavByType("user");overrideAJAX();storageObject.init();setupListeners();navBtnListeners();initOverlayButtons();translateMagnificPopup();$.magnificPopup.defaults.fixedBgPos=true;fillInConstants();loadExternalData();console.log("[Startup] "+(new Date()-b)+"ms, start logging in.");initLogin()}catch(a){alert("Error occured while initializing!\n"+a.toString()+"\nPlease report the fatal error.");throw a}}function fillInConstants(){$("#btn-user-name").html("Logging in...");$("#dp-mac").html(storageObject.load("mac"));$(".fill-version").html(VERSION_MAJOR+VERSION_MINOR+VERSION_COUNT);$(".fill-version-count").html(VERSION_COUNT);$(".fill-last-modify").html(LAST_MODIFY);$(".fill-random-tip").html(randomTip[Math.floor(Math.random()*randomTip.length)].replaceAll("|","<br/>"))}function setupListeners(){var a=new Date();checkMAC();$(".login-dialer button").addClass("large").css("width","33%").click(fillMAC);$("#accountBtn").click(showUserLightbox);$(".action-account").click(showUserLightbox);$("#logoutBtn").click(function(){navClick();confirmClearMAC()});$(".action-refresh").click(refreshMain);$("#nav-following").click(showFollowingPopup);$("#nav-follower").click(showFollowerPopup);$("#login-input-mac").keyup(checkMAC);$("#editInfoBtn").click(modalMyInfo);$("#pinRefreshBtn").click(checkAllPinPosts);$("#pinAllReadBtn").click(clearAllPinUnread);$(document).on("click",".userlightbox",showUserLightbox).on("click",".moodlightbox",showMoodLightbox).on("click",".voterlightbox",showVoterLightbox).on("click",".action-reply",modalShowReply).on("click",".action-award",modalShowAward).on("click",".action-badgewinner",modalShowBadgeWinners).on("click",".action-vote",voteClick).on("click",".action-reveal-rm",readRMPostAndRender).on("click",".action-seek-this-person",seekReplyByPerson).on("shown.bs.popover",'*[data-toggle="popover"]',popOverShownHandler);console.log("[init/SetupListeners] "+(new Date()-a)+"ms")}function loadExternalData(){var a=$("[data-load]");var b=0;a.each(function(){var c=$(this);c.load(c.data("load"),function(){b++;console.log("[~DataLoad] loaded "+c.data("load")+", "+b+" / "+a.length);if(a.length==b){reinit();initOnce();initHashRoutes()}})})}var initOnce=function(){var e=new Date();$("#btn-loadmore").click(loadMore);$("#btn-loadmore-reply").click(loadMoreReply);$("#btn-loadmore-users").click(loadMoreUsers);$("#btn-loadmore-announcement").click(loadMoreAnnouncement);$(".action-refresh-reply").click(refreshReply);$(".action-refresh-by-score").click(sortReplyByScore);$(".action-refresh-reverse").click(sortReplyReverse);$("#action-toggle-pin-list").click(togglePinList);$(".action-pin-post").click(togglePinCurrentPost);$(".action-dismiss").click(modalHide);$("#postshare-category").change(postshareCategoryChange);for(var c=0;c<SUBJECT_CATEGORY_NAME.length;++c){var d="",a=1;$("#postshare-subject-category").append(TAG("option","","value='"+(c+1)+"'",SUBJECT_CATEGORY_NAME[c]));$("#postshare-subject-container").append(TAG("select","postshare-subject","multiple='multiple'",""));while(SUBJECT_MAP[String(c+1)+numFill(a,4)]){var b=String(c+1)+numFill(a,4);d+=TAG("option","","value='"+b+"'",SUBJECT_MAP[b]);a++}$(".postshare-subject").eq(c).html(d)}$(".postshare-subject").change(changeSubjectSelection);$("#postshare-subject-category").change(postshareSubjectCategoryChange);postshareSubjectCategoryChange();postshareCategoryChange();$("#users-search").submit(searchUserSubmit);$("#popup-reply-accordion-content").collapse();$("#_loadingState")[0].outerHTML="";switchVisible("#header,#root",true);initOnce=function(){};console.log("[initOnce] ended "+(new Date()-e)+" ms")};function initOverlayButtons(){$("#btn-bringtop").click(function(){$("html,body").animate({scrollTop:0},400)});$(window).scroll(function(){if($(this).scrollTop()>800){$("#btn-bringtop").fadeIn("fast")}else{$("#btn-bringtop").stop().fadeOut("fast")}});$("#btn-bringtop").fadeOut("fast")}function checkUseMobileRule(){if(useLocalStorage){USE_MOBILE_RULE=!!localStorage.getItem("use-mobile")||false}if(USE_MOBILE_RULE){console.log("[checkUseMobileRule] Rule applied.")}}function translateTimeago(){$.timeago.settings.strings={prefixAgo:null,prefixFromNow:null,suffixAgo:"前",suffixFromNow:"後",seconds:"%d 秒",minute:"約 1 分鐘",minutes:"%d 分鐘",hour:"約 1 小時",hours:"%d 小時",day:"約 1 天",days:"%d 天",month:"約 1 個月",months:"%d 個月",year:"約 1 年",years:"%d 年",numbers:[],wordSeparator:""}}var myProfile={};var SKIP_SPLASH=0;var GIVE_UP_LOADING=0;var FREEZE=0;function initLogin(){if(location.hash!=""&&location.hash!="#!"){SKIP_SPLASH=true}if(!SKIP_SPLASH){modal("#popup-welcome",true,true);splashNeedClose=true}$("#welcome-mac").html(storageObject.load("mac"));if(!storageObject.load("mac")){modal("#popup-login",true,true);return}if(isLocalStorageSupported()){var a;if(a=localStorage.getItem("identity")){try{myProfile=JSON.parse(a);fillIdentity();if(!GIVE_UP_LOADING){viewLoad({})}console.log("[doLogin] Cached identity discovered. Use it.")}catch(b){localStorage.removeItem("identity");console.log("[doLogin] Corrupted user data. Cleared.")}}}readProfile();getPinList();if(!URL_PROXY){$("#welcome-hst").addClass("error").html("[N/A]")}else{loadFromProxy("did_login",{did:storageObject.load("mac")},function(c){$("#welcome-hst").addClass("success").html("[200 OK]")})}}function relogin(){if(!checkMAC()){alert("MAC無效，無法登入。");return}storageObject.save("mac",$("#login-mac").html());location.reload()}function fillIdentity(){assert(myProfile,"fillIdentity");$("#accountBtn").data("id",myProfile.username);$(".action-account").data("id",myProfile.username);$(".fill-username").html(myProfile.name);$("#btn-user-img").attr("src",imageLM(myProfile.image))}function doLogin(b){var a=!(myProfile=={});myProfile=b.profile;currentProfile=myProfile;if(!a){return}$("#welcome-mac").addClass("success");$("#welcome-msg").html("Hello, "+myProfile.name+" ("+myProfile.username+")");$("#welcome-img").attr("src",imageLM(myProfile.image));$("#welcome-school").html(myProfile.school);fillIdentity();if(isLocalStorageSupported()){if(!localStorage.getItem("identity")){if(!GIVE_UP_LOADING){viewLoad({})}}localStorage.setItem("identity",JSON.stringify(b.profile))}else{if(!GIVE_UP_LOADING){viewLoad({})}}$("#welcome-hint").css("opacity",1);if(!SKIP_SPLASH){setTimeout(function(){if(splashNeedClose){modalHide()}},SPLASH_OFF_DURATION)}}function doLoginFailure(b){$("#welcome-msg").html("Login Failed!");$("#welcome-mac").addClass("error");var a=confirm("登入失敗...\n要清除掉MAC然後重新嘗試嗎？");if(a){clearClientData();location.reload()}}function checkMAC(){var a=macConverter($("#login-input-mac").val());$("#login-mac").html(a.mac);if(a.valid){$("#login-mac").removeClass("text-muted")}else{$("#login-mac").append(" [無效]");$("#login-mac").addClass("text-muted")}return a.valid}function confirmClearMAC(){if(storageObject.load("mac")){ans=confirm("即將從 LMClient 登出，確定？");if(ans){clearClientData();alert("登出成功。\n謝謝您的使用，歡迎再度光臨。");location.reload()}else{return}}}function fillMAC(){if($(this).hasClass("void")){return}if($(this).hasClass("backspace")){var a=$("#login-input-mac")[0].value;$("#login-input-mac")[0].value=a.substr(0,a.length-1)}else{if(!checkMAC()){$("#login-input-mac")[0].value+=$(this).html()}}checkMAC()}function clearClientData(){storageObject.remove("mac");localStorage.removeItem("identity")}function modalShowReply(b){var a=$(this);var c=a.data("id");if(a[0].nodeName=="BUTTON"){$(".marked").removeClass("marked");a.parent().parent().addClass("marked")}location.hash="#!/post/"+c+""}function registerListUtil(e){
/*! Since v1.44, JSON flavor :) */
;var d="",c=null;if(typeof e=="undefined"){c=$}else{if(typeof e=="string"){d=e;c=$(e);if(!c.length){c=$}}else{c=e;d=c.selector}}var b=[function(g){Shadowbox.setup(d+" a.imglightbox",g);return f},function(){c.find('*[data-toggle="popover"]').popover({container:"body",html:true,placement:function(){if($(window).width()<500){return"bottom"}else{return"right"}},trigger:"hover",delay:{show:FX_POPOVER_SHOW_DELAY,hide:FX_POPOVER_HIDE_DELAY}});return f},function(){c.find("time.timeago").timeago();return f}];var a=b.length;xyz=b;var f={setupLightbox:b[0],registerPopOver:b[1],registerTimeAgo:b[2],registerAll:function(){for(var g=0;g<a;++g){b[g]()}}};return f}function popOverShownHandler(){var a=$(this);registerListUtil(a).setupLightbox()}function voteClick(i){var m=$(this);var c=m.parent().children();var h=m.data();var a=h.id;var b=h.func;var g=h.role;var l=c.eq(0);if(m[0]==l[0]){l=c.eq(1)}var f=l.data();var k=f.func;var d=f.role;var j=COLOR_CLASS.VOTE_BUTTON;postVote(b,a,function(e){m.removeClass().addClass(j._common+" "+j[e.message]).data("func",b=="clear"?g:"clear");if(b!="clear"&&k=="clear"){l.removeClass().addClass(j._common+" "+j.clear).data("func",d)}})}function readRMPostAndRender(){var b=$(this);if(!b.data("rm")){return}var a=confirm("觀看被RM的貼文是一項禁忌的功能，於 2014/2/12 推出，請低調使用。\n還是要繼續嗎？");if(!a){return}b.html(ICON("busy")+" 載入RM貼文中...");loadFromProxy("RMpost",{id:b.data("rm"),mac:storageObject.load("mac")},function(e){if(!e){return}var d=modifyObj(e.list[0],e);d.flagged=false;d._flagged=true;var c=b.parents(".list").eq(0);var f=!c.hasClass("autoheight");c.replaceWith(renderPostListView(d,f));registerListUtil(c).registerAll()})}function loadMore(){mainLoader.loadMore()}function loadMoreReply(){$("#reply-content-loading").html(getLoadingRing("center"));setShow("#reply-content-loading","",false);getRelated({id:replyObject.id,before:replyObject._oldest,user:replyObject._user_filter})}function loadMoreAnnouncement(){setShow("#announcement-loading","",false);listAnnouncement({before:lastestAnnouncementID,count:10},false)}function refreshMain(){viewLoadMerge(clearParamTimeStamp({}),true)}function viewRecognize(f,a){f=f||{};var d="",g="",b="";var e=f.category&&f.category.indexOf("__")==0;if(f.user){if(f.user==myProfile.uid||f.user==myProfile.username||(e&&isMyself(currentProfile))){d="自己";g=COUNT.HOMEPAGE}else{d=currentProfile.name+" ";g=COUNT.NOTIFICATION}d+="的"+getCategory(f.category);b="user"}else{if(f.category){b=f.category;d=getCategory(f.category);if(f.sort=="score"){g=COUNT.HOT}else{if(f.sort=="date"){g=COUNT.NOTIFICATION}else{g=COUNT.NOTIFICATION}}}else{if(f.sort){d="[不分類]";b="";g=COUNT.NOTIFICATION}else{d="首頁";b="homepage";g=COUNT.NOTIFICATION}}}if(f.category=="scrapbook"&&mainLoader.parse==parsePostThumbView){g=COUNT.ALBUM}if($("#pin-list").css("display")!="none"){togglePinList()}switchNavByType(b);navUpdate(f);setLocation(d);f.count=g}function viewLoad(b,a,c){mainLoader.clearBefore=a;mainLoader.parse=c||parsePostListView;mainLoader.load("list",b)}function viewLoadMerge(b,a,c){viewLoad($.extend(mainLoader.lastReq,b),a,c)}function clearParamTimeStamp(a){a=a||{};a.before=null;a.after=a.after?OLDEST_TIMESTAMP:null;return a}function getCategory(b){var a;if(b){if(b.indexOf("__")==0){if(b=="__badge"){return"獎獎堂"}}else{if(a=RENDER_ENG.category1[b]){return a.label}else{if(a=RENDER_ENG.category2[b]){return a.label}}}}return"大聲公"}function setLocation(a){$("#nav-location").html(a)}function deleteProp(a,b){a[b]=null;return a}function replyBringToTop(){var b=$(".mfp-wrap");if(b.css("position")=="absolute"){var a=parseInt(b.css("top"));$("html,body").scrollTop(a)}else{b.animate({scrollTop:0},FX_BRING_TOP_DURATION)}}function getLoadingRing(a){if(!isAnimationSupported()){return TAG("div","text-center"+(a?" "+a:""),ICON("loading")+" Now Loading")}var c="";for(var b=0;b<5;b++){c+=TAG("span","circle","")}return TAG("div","loader-ring"+(a?" "+a:""),c)}function orientateLightbox(a,b){var d=$(window);var c=d.width();if(c<=640){return{w:a*1.25,h:a}}return{w:a,h:b}}function showUserLightbox(a){lightbox({content:$(".ext-userview")[0].outerHTML,player:"html",options:{onFinish:function(b){addToUserLightbox()}},height:360,width:600});userProfile=null;readUserProfile({user:$(this).data("id")})}function showMoodLightbox(a){var b=orientateLightbox(900,450);lightbox({content:$(".ext-moodview")[0].outerHTML,player:"html",options:{onFinish:function(c){assert(detailedMood.length==5,"showMoodLightbox","Mood is not loaded yet!");addToMoodLightbox();$(".ext-moodview").css("opacity",1)}},height:b.h,width:b.w})}function showVoterLightbox(){voter=[];var a=orientateLightbox(900,450);lightbox({content:$(".ext-voterview")[0].outerHTML,player:"html",options:{onFinish:function(b){addToVoterLightbox()}},height:a.h,width:a.w});getVoter({id:$(this).data("id"),count:COUNT.VOTER})}function addToUserLightbox(){if(userProfile){var c=userProfile;var b=$("#sb-player .ext-userview");if(!b[0]){console.log("[addToUserLightbox] type=objmiss");return}var e=b.find(".userview-block");var d=b.find(".userview-tool");if(!c._rendered){c._rendered=true;$("#sb-player .ext-userview .userview-cover").attr("src",imageLM(c.cover,"X"));b.find(".userview-toggle").click(function(){b.find(".userview-viewport").toggleClass("alt")});b.find(".userview-desc").html(processContent(c.desc));b.find(".userview-misc").html("地點："+c.location+"<br/>使用者UID："+c.uid+"<br/>使用者ID："+c.id);b.find(".userview-image").attr("src",imageLM(c.image));e.find(".title").html(c.name+" ("+c.username+")");e.find(".subtitle").html(c.school+" "+(c.class_name=="TH"?"老師":c.class_name));b.css("opacity",1);d.find(".userview-go").click(function(){currentProfile=c;viewLoad({user:c.username},true);modalHide();Shadowbox.close()})}var f=getRelationWithUser(c)||"";f&&(f+="‧");b.find(".userview-info").html(f+("已關注 %%% 人‧被 @@@ 人關注".replace("%%%",c.following_count).replace("@@@",c.followers_count)));switchVisible(e.find(".following"),c.is_followed_by);var a=d.find(".userview-following");a.data("id",c.username);a.off().removeClass("danger info");if(isMyself(c)){a.attr("disabled","disabled").html(ICON("home")+" 你自己")}else{if(c.is_following){a.addClass("danger").html(ICON("link-2")+" 取消關注").click(function(){postIfFollow($(this).data("id"),false)})}else{a.addClass("info").html(ICON("link")+" 關注").click(function(){postIfFollow($(this).data("id"),true)})}}}console.log("[addToUserLightbox] type="+(c?"ok":"pending"))}var detailedMood=[];function addToMoodLightbox(){assert(detailedMood.length==5,"addToMoodLightbox","Mood is not loaded yet!");var b=$("#sb-player .ext-moodview .list-content").find("div");for(var e=0;e<5;++e){var a=detailedMood[e],f=[];for(var d=0;d<a.length;d++){var c=renderAvatarRaw(a[d],"inline shadow"+(!a[d]._is_dummy?" userlightbox":""));var h=renderUserRaw(a[d]);var g=TAG("small","["+dateConverter(a[d]._mood_date)+"]");f.push(TAG("div","","style='display:inline-block'",c+h+"<br/>"+g))}b.eq(e).html(f.length?f.join("&nbsp;&nbsp;"):TAG("span","text-muted","Nobody..."))}}var voter=[];function addToVoterLightbox(){var b=$("#sb-player .ext-voterview .list-content").find("div");if(!b[0]){console.log("[addToVoterLightbox] type=objmiss");return}if(!voter.length){console.log("[addToVoterLightbox] type=pending");return}for(var e=0;e<2;++e){var a=voter[e],f=[];for(var d=0;d<a.length;d++){var c=renderAvatarRaw(a[d],"inline shadow"+(!a[d]._is_dummy?" userlightbox":""));var h=renderUserRaw(a[d]);var g=TAG("small","["+dateConverter(a[d]._vote_date)+"]");f.push(TAG("div","","style='display:inline-block'",c+h+"<br/>"+g))}b.eq(e).html(f.length?f.join("&nbsp;&nbsp;"):TAG("span","text-muted","Nobody..."))}$(".ext-voterview").css("opacity",1);console.log("[addToVoterLightbox] type=ok")}function openPostShareForm(){setShow("#postshare-ok","#postshare-processing",false);modal("#popup-postshare",false,true)}function openNewsForm(){modal("#popup-news",false,true)}function showFollowerPopup(){showUsersPopup((isMyself(currentProfile)?"":currentProfile.name+" 的 ")+"粉絲團 ("+currentProfile.followers_count+")");clrUsersPopup();switchVisible("#users-search",false);searchFollower(null,true);usersMoreFN=searchFollower}function showFollowingPopup(){showUsersPopup((isMyself(currentProfile)?"":currentProfile.name+" 的 ")+"我關注 ("+currentProfile.following_count+")");clrUsersPopup();switchVisible("#users-search",false);searchFollowing(null,true);usersMoreFN=searchFollowing}function showUsersPopup(a){modal("#popup-users");setShow("#users-loading","#users-ok",false);if(usersMoreFN!=searchUser){clrUsersPopup()}$("#popup-users").find("h3:eq(0)").html(a)}var shadowboxBadgeImageOption={onOpen:function(){$("#sb-body").addClass("white")},onClose:function(){$("#sb-body").removeClass("white")}};function modalShowAwardRaw(m){showUsersPopup("獎牌");clrUsersPopup();switchVisible("#users-search",false);switchVisible("#users-award",true);setShow("#users-loading","#users-ok",true);var f=m[m.length-1].badge;var e=badgeSearch(f);var a=SUBJECT_MAP[m[0].subject]||"";var b=$("#users-award-img");b.html(TAGb2(f));registerListUtil(b).setupLightbox(shadowboxBadgeImageOption);$("#users-award-info > [data-field='name']").html(e[0][0]+e[1]);$("#users-award-info > [data-field='subject']").html(a);$("#users-award-desc1").html(e[0][1][0].replaceAll("|","<br/>"));$("#users-award-desc2").html(e[0][1][1].replaceAll("|","<br/>"));var h=$(".users-award");h.removeClass("info");var k=new Array(3);for(var j=0;j<m.length;++j){var d=badgeOrder(m[j].badge);k[d]=m[j]}var l=0;for(var j=0;j<3;++j){var c=h.eq(j).children("td");c.eq(1).html(e[0][2][j]);if(k[j]){var g=k[j].badge;l=j;c.eq(2).html(dateConverter(k[j].date,true));c.eq(3).html(renderButtonRaw("觀看","success action-badgewinner",g))}else{c.eq(2).html("...");c.eq(3).html("...")}}h.eq(l).addClass("info");searchBadgeWinners({badge:f},true)}function modalShowAward(){var d=$(this).data();if(d.id){modalShowAwardRaw(badgeObj[d.id])}else{var a=d.badge;var c=d.subject;var b=d.date;var e=[{badge:a,subject:c,date:b}];modalShowAwardRaw(e)}}function modalShowBadgeWinners(){var e=$(this).data();var a=e.id;var d=e.subject;var b=badgeSearch(a);var c=$("#users-award-img");c.html(TAGb2(a));registerListUtil(c).setupLightbox(shadowboxBadgeImageOption);$("#users-award-info > [data-field='name']").html(b[0][0]+b[1]);searchBadgeWinners({badge:a},true)}function postshareSubjectCategoryChange(){var c=(this==window)?"0":$(this).val()-1;var b=(c<0);for(var a=0;a<SUBJECT_CATEGORY_NAME.length;++a){switchVisible(".postshare-subject:eq("+a+")",b||a==c);$(".postshare-subject").eq(a).attr("size",b?1:12)}}function postshareCategoryChange(){var a=(this==window)?"share":$(this).val();switchVisible("#postshare-o-subject",a=="question"||a=="watch");switchVisible("#postshare-o-image-rect",a=="scrapbook");switchVisible("#postshare-o-image-rect-no",a!="scrapbook");switchVisible("#postshare-o-url",a=="scrapbook"||a=="watch");switchVisible("#postshare-o-url-scrap",a=="scrapbook");switchVisible("#postshare-o-url-video",a=="watch")}function changeSubjectSelection(){$("#postshare-subject-count").html($(".postshare-subject option:selected").length)}function selectAllSubjects(b){var a=$(".postshare-subject option:not(:selected)").length!=0;$(".postshare-subject option").prop("selected",a);changeSubjectSelection();b.preventDefault()}var myInfoCount=0;function modalMyInfo(){if(!myProfile){throw new Error("myProfile is not ready to be used!")}setShow("#myinfo-processing","#myinfo-ok",true);modal("#popup-myinfo",false,true);$("#myinfo-name").val(myProfile.name);$("#myinfo-username").val(myProfile.username);$("#myinfo-email").val(myProfile.email);$("#myinfo-web").val(myProfile.web);$("#myinfo-location").val(myProfile.location);$("#myinfo-build_number").val(myProfile.build_number);$("#myinfo-desc").val(myProfile.desc)}function postMyInfoForm(){setShow("#myinfo-processing","#myinfo-ok",false);var a=addFormDataIfChanged(["name","username","email","web","build_number","location","desc"],"#myinfo-");if(a){myInfoCount++;postProxy("updateProfile",a,myInfoSuccess)}postMyInfoImage($("#myinfo-file-image")[0],"image");postMyInfoImage($("#myinfo-file-cover")[0],"cover");if(!a&&myInfoCount==0){checkMyInfo(true)}}function postMyInfoImage(b,a){if(b.files&&b.files[0]){myInfoCount++;var c=new FormData();c.append("device",storageObject.load("mac"));c.append(a,b.files[0]);postProxy("uploadProfileImage",c,myInfoSuccess)}}function myInfoSuccess(a){myInfoCount--;if(myInfoCount){notify.info("成功上傳！(剩餘"+myInfoCount+"個上傳作業)")}else{checkMyInfo()}}function checkMyInfo(a){if(myInfoCount!=0){return}readProfile();notify.complete({message:a?"個人資料並未更動。":"成功修改個人資料！"});modalHide()}function addFormDataIfChanged(a,e){var f=new FormData(),c=false;f.append("device",storageObject.load("mac"));for(var b=0;b<a.length;++b){var g=myProfile[a[b]];var d=$(e+a[b]).val();if(g!=d){console.log("[addFormDataIfChanged] changed id="+a[b]);f.append(a[b],d);c=true}}return c?f:null}function navBtnListeners(){$("#allActivity").click(function(){navClick();viewLoad({sort:"date"},true)});$("#myActivity").click(function(){navClick();viewLoad({},true);currentProfile=myProfile});$("#myActivity2").click(function(){navClick();viewLoad({user:myProfile.username,sort:"date"},true);currentProfile=myProfile});$("#shh5").click(function(){navClick();viewLoad({category:"!badge",sort:"date"},true)});$("#action-announcement").click(function(){navClick();listAnnouncement({count:COUNT.ANNOUNCEMENT},true);modal("#popup-announcement");setShow("#announcement-loading","",false)});$("#action-history").click(function(){navClick(reloadWithReversed)});$("#action-search").click(function(){navClick();showUsersPopup("搜尋使用者");setShow("#users-loading","#users-ok",true);switchVisible("#users-search",true);switchVisible("#users-award",false)});$("#nav-myfollow").click(function(){mainLoader.lastReq=deleteProp(deleteProp(mainLoader.lastReq,"user"),"sort");viewLoad(mainLoader.lastReq,true)});$("#nav-new").click(function(){mainLoader.lastReq=deleteProp(mainLoader.lastReq,"user");viewLoadMerge(clearParamTimeStamp({sort:"date"}),true)});$("#nav-hot").click(function(){mainLoader.lastReq=deleteProp(mainLoader.lastReq,"user");viewLoadMerge(clearParamTimeStamp({sort:"score"}),true)});$("#nav-unanswered").click(function(){if(mainLoader.lastReq.unanswered){viewLoad(deleteProp(mainLoader.lastReq,"unanswered"),true)}else{viewLoadMerge(clearParamTimeStamp({unanswered:true,sort:"date"}),true)}});$("#nav-album").click(function(){var a={category:"scrapbook"};a.user=mainLoader.lastReq.user||myProfile.username;viewLoadMerge(a,true,parsePostThumbView)});$("#nav-award").click(function(){if(mainLoader.lastReq.category=="__badge"){mainLoader.lastReq.category=mainLoader.lastReq._category;viewLoadMerge({},true)}else{mainLoader.lastReq._category=mainLoader.lastReq.category;viewLoadMerge({category:"__badge"},true)}});$(".action-sel").click(function(){var a=$(this).data("category");if(a!="all"){viewLoadMerge({category:a},true)}else{mainLoader.lastReq=deleteProp(mainLoader.lastReq,"category");viewLoad(mainLoader.lastReq,true)}});$(".action-sel-em").click(function(){var b=$(this).data();var a=b.sort||null;viewLoad(clearParamTimeStamp({category:b.category,sort:a}),true)})}function switchNavByType(a){switchVisible("nav .questionmenu",a=="question");switchVisible("nav .usermenu",a=="user"||a=="homepage"||a=="__badge");switchVisible("nav .nohomemenu",a=="user");switchVisible("nav .categorymenu",a=="question"||a=="share"||a=="scrapbook"||a=="comment"||a=="answer"||a=="watch"||a=="practice"||a=="annotation"||a=="course"||a=="!badge");switchVisible("nav .hotmenu",a=="question"||a=="share"||a=="scrapbook"||a=="answer")}function navUpdate(c){var a=$("nav");a.find(".categorymenu,.questionmenu,.usermenu,.hotmenu").find("a").removeClass("text-muted").removeClass("text-success");var b=[];if(c.unanswered){b.push("#nav-unanswered")}if(c.category=="scrapbook"){b.push("#nav-album")}if(c.category=="__badge"){b.push("#nav-award")}switchVisible(".historymenu:eq(0)",c.after==OLDEST_TIMESTAMP);if(!a.find(".hotmenu:eq(0)").hasClass("hide")){switchVisible(".hotmenu:eq(0)",!c.unanswered)}if(!a.find(".categorymenu:eq(0)").hasClass("hide")){switchVisible(".categorymenu:eq(0)",c.category)}if(c.user==myProfile.uid||c.user==myProfile.username){b.push("#nav-myself")}else{if(c.sort=="score"){b.push("#nav-hot")}else{if(c.sort=="date"){b.push("#nav-new")}else{b.push("#nav-myfollow")}}}$(b.join(",")).removeClass("text-muted").addClass("text-success")}notify={connectFailure:function(a,b){$.Notify({caption:ICON("cancel")+" 連線失敗!",content:a+"<br/>請手動按鈕重新整理對應內容. ",style:{background:"rgb(255,45,25)",color:"white"},timeout:b||NOTIFY_TIME.MEDIUM})},abort:function(a,b){$.Notify({caption:ICON("cycle")+" 重新連線. ",content:a,style:{background:"white",color:"rgb(51,51,51)"},timeout:b||NOTIFY_TIME.SHORT})},verbose:function(a,b){$.Notify({caption:ICON("console")+" 除錯.",content:a,style:{background:"white",color:"rgb(51,51,51)"},timeout:b||NOTIFY_TIME.MEDIUM})},warning:function(a,b){$.Notify({caption:ICON("console")+" 注意!",content:a,style:{background:"rgb(255,220,0)",color:"rgb(51,51,51)"},timeout:b||NOTIFY_TIME.LONG})},error:function(a,b){$.Notify({caption:ICON("cancel")+" 錯誤!",content:a,style:{background:"rgb(170,0,0)",color:"white"},timeout:b||NOTIFY_TIME.MEDIUM})},complete:function(a,b){$.Notify({caption:ICON("checkmark")+" 完成!",content:a.message+"<br/>"+notifyStatusRenderer(a.status),style:{background:"rgb(0,138,0)",color:"white"},timeout:b||NOTIFY_TIME.MEDIUM})},info:function(a,b){$.Notify({caption:ICON("star-3")+" 成功!",content:a,style:{background:"rgb(27,161,226)",color:"white"},timeout:b||NOTIFY_TIME.MEDIUM})},update:function(a,b){if(a.once){$.Notify({caption:ICON("flag-2")+" 共有 "+a.count+" 個追蹤貼文更新了! ",content:"在主畫面點開追蹤列表查看! ",style:{background:"rgb(27,161,226)",color:"white"},timeout:b||NOTIFY_TIME.LONG});return}$.Notify({caption:ICON("flag-2")+" 追蹤貼文有 "+a.count+" 個更新! ",content:a.message+"<br/>點擊此處查看! "+TAG("span","","data-id='"+a.id+"'",""),style:{background:"rgb(27,161,226)",color:"white"},timeout:b||NOTIFY_TIME.LONG});$(".notify-container span[data-id='"+a.id+"']").parent().parent().data("id",a.id).click(modalShowReply)}};function notifyStatusRenderer(a){if(!a||!a.http_code){return""}return"花費時間："+roundTo(a.total_time,2)+" sec<br/>大小 (↑/↓)："+roundTo(a.size_upload/1000,3)+" / "+roundTo(a.size_download/1000,3)+" KB<br/>速度 (↑/↓)："+roundTo(a.speed_upload/1000,3)+" / "+roundTo(a.speed_download/1000,3)+" KB/sec"}var pinList;var pinCount,pinFinish,pinDeferred,pinIdle=true;var pinObject;function initPinList(c){c=c?c.data:{};pinIdle=false;pinList={};pinObject={};pinCount=0;pinDeferred=0;for(var a in c){var b=c[a];if(b){addPinPost(a,b.count,b.unread);readPinPostContent(a)}}pinFinish=0;updatePinCount();console.log("[getPinList] Success",c);setInterval(checkAllPinPosts,30000)}function readPinPostContent(a){loadFromLM("read",{id:a},initPinPost,null,true)}function checkSinglePinPost(a){loadFromLM("read",{id:a},updateSinglePinPost,null,true)}function initPinPost(f){var e=modifyObj(f.list[0],f);var g=e.id;var b=pinList[g].count;var d=e.ref_count;var c=d-b;var a=$("#pin-list .list[data-id='"+g+"']");a.removeClass("undone").html(renderPinPostInner(e));console.log("initPinPost",b,"->",d);if(c){assert(c>0,"updateSinglePinPost","Negative difference.");pinList[g].unread+=c;pinList[g].count=d;loadFromLM("list",{related:g,sort:"date",count:Math.min(pinList[g].unread,COUNT.PIN)},updatePinPostReply,null,true);pinDeferred++}else{pinFinish++}if(pinList[g].unread){switchPinMark(g,true).find(".label.fill-count").html("+"+pinList[g].unread)}else{switchPinMark(g,false).find(".label.fill-count").html(0)}updatePinCount()}function updatePinPostReply(f){pinFinish++;updatePinCount();var c=f.list;if(!f.list[0]){return}var g=f.list[0].related;var b=$("#pin-list .list[data-id='"+g+"']");var e="";for(var a in c){var d=modifyObj(c[a],f);e+=TAG("span",renderPinPostReply(d))+"&nbsp;&nbsp;&nbsp;"}if(b.find(".list-appendix").length){b.find(".list-appendix").html(e)}else{b.append(TAG("div","list-appendix text-muted",e))}}function checkAllPinPosts(){if(!pinIdle){return}pinFinish=0;pinIdle=false;for(var a in pinList){checkSinglePinPost(a)}}function updateSinglePinPost(f){var e=modifyObj(f.list[0],f);var g=e.id;var b=pinList[g].count;var d=e.ref_count;var c=d-b;var a=$("#pin-list .list[data-id='"+g+"']");if(c){assert(c>0,"updateSinglePinPost","Negative difference.");if(pinList[g].unread!=c&&pinIdle){notify.update({count:c,id:g,message:truncateText(e.message.replaceAll("\n"," "),20)})}pinList[g].count=d;pinList[g].unread+=c;if(pinIdle){postSavePinList()}else{pinDeferred++}loadFromLM("list",{related:g,sort:"date",count:Math.min(pinList[g].unread,COUNT.PIN)},updatePinPostReply,null,true)}else{pinFinish++}if(pinList[g].unread){switchPinMark(g,true).find(".label.fill-count").html("+"+pinList[g].unread)}else{switchPinMark(g,false).find(".label.fill-count").html(0)}updatePinCount()}function addPinPost(c,b,a){pinList[c]={unread:a||0,count:b||0};pinObject[c]={};$("#pin-list").append(TAG("div","list post autoheight undone","tabindex='0' data-id='"+c+"'",TAG("div","list-content","載入 "+c+" 中...")));pinCount++;updatePinCount()}function removePinPost(a){pinList[a]=undefined;pinObject[a]=undefined;$("#pin-list .list[data-id='"+a+"']").remove();pinCount--;pinFinish--;updatePinCount()}function clearUnread(a){switchPinMark(a,false).find(".label.fill-count").html(0);pinList[a].unread=0}function clearAllPinUnread(){for(var a in pinList){clearUnread(a)}}function updatePinCount(){var b=pinFinish,a=pinCount;var c=$(".fill-pin-count");if(b==a){c.html(a);c.parent().removeClass("text-muted").addClass("text-info");pinReady=true;pinIdle=true;console.log("[updatePinCount] pinReady and pinIdle");if(pinDeferred){notify.update({once:true,count:pinDeferred});postSavePinList();pinDeferred=0}}else{c.html(TAG("div","progress-bar","data-role='progress-bar' data-value='0'",""));c.find("div.progress-bar").data("value",b/a*100);c.parent().removeClass("text-info").addClass("text-muted")}}function togglePinCurrentPost(){var a=replyObject.id;if(!pinList){notify.error("追蹤列表尚未就緒, 請稍後再試.");return}if(!pinList[a]){addPinPost(a,replyObject.ref_count);readPinPostContent(a);switchPinMark(a,false).find(".label.fill-count").html(0);notify.info("追蹤現在是ON",1000)}else{removePinPost(a);notify.info("追蹤現在是OFF",1000)}postSavePinList();checkPinPostButton()}function checkPinPostButton(){var b="#reply-tool .action-pin-post";var a=pinList!==undefined;switchVisible(b,a);if(a){var c=pinList[replyObject.id];$(b).html(c?ICON("star-3")+" 追蹤ON":ICON("star")+" 追蹤OFF");switchClass(b,"primary",c)}}function togglePinList(){var a=$("#pin-list");if(a.css("display")=="none"){a.fadeIn({duration:FX_VIEW_DURATION,queue:false}).css("display","none").slideDown(FX_VIEW_DURATION)}else{a.css("opacity",1).fadeOut({duration:FX_VIEW_DURATION,queue:false}).slideUp(FX_VIEW_DURATION)}}function switchPinMark(c,b){var a=$("#pin-list .list[data-id='"+c+"']");switchClass(a.find(".label.fill-count"),"warning zoomin",b);switchClass(a.find(".action-reply"),"primary",!b);switchClass(a.find(".action-reply"),"success",b);return a}function loadMoreUsers(){$("#users-body-loading").html(getLoadingRing("center"));setShow("#users-body-loading","",false);usersMoreFN()}function searchUser(b,a){b=b||usersMoreFN._param||{};b.count=COUNT.USER_SEARCH;if(a){clrUsersPopup()}switchVisible("#users-award",false);$("#users-body-loading").html(getLoadingRing("center"));setShow("#users-body-loading","",false);lastestUsersReq=loadFromLM("profile/search",b,addToUsersPopup);usersMoreFN._param=b;return b}function searchFollowing(b,a){b=b||usersMoreFN._param||{};if(a){clrUsersPopup()}switchVisible("#users-award",false);b.count=COUNT.USER;b.user=currentProfile.username;lastestUsersReq=loadFromLM("following",b,addToUsersPopup);usersMoreFN._param=b;return b}function searchFollower(b,a){b=b||usersMoreFN._param||{};if(a){clrUsersPopup()}switchVisible("#users-award",false);b.count=COUNT.USER;b.user=currentProfile.username;lastestUsersReq=loadFromLM("followers",b,addToUsersPopup);usersMoreFN._param=b;return b}function searchBadgeWinners(b,a){b=b||usersMoreFN._param||{};if(a){clrUsersPopup()}b.count=COUNT.USER_BADGE;lastestUsersReq=loadFromLM("badge/winners",b,addToUsersPopup);usersMoreFN=searchBadgeWinners;usersMoreFN._param=b;return b}function searchUserSubmit(a){a.preventDefault();var b={q:encodeURIComponent($("#users-searchbox").val())};usersMoreFN=searchUser;searchUser(b,true)}function badgeTranslate(d){if(isLevel(d)){var a=HASH.levelName[d];return a[0]+" ("+a[1]+"/16)"}var c=d.split("_");var b=badgeSearch(d);b[0]=b[0]||[];return(b[0][0]||c[0])+(b[1]||c[1])}function isLevel(a){return !!HASH.levelName[a]}function badgeSearch(a){var b=a.split("_");return[HASH.badgeName[b[0]]||null,HASH.badgeLevel[b[1]]||null]}function compareBadgeLevel(d,c){return badgeOrder(d)>badgeOrder(c)}function badgeOrder(b){var a=b.split("_");var c=a[a.length-1];return({bronze:0,silver:1,gold:2})[c]}var cookie=null;var useLocalStorage=false;function isLocalStorageSupported(){return localStorage!==null&&localStorage!==undefined}var storageObject={init:function(){assert(!cookie,"storageObject.init","cookie is not null.");cookie={};if(isLocalStorageSupported()){useLocalStorage=true;var c=$.cookie("mac");if(c){storageObject.save("mac",c);$.removeCookie("mac")}}else{var b=$.cookie();for(var a in b){storageObject.load(a)}}},flush:function(b,c){if(useLocalStorage){}else{if(b){return storageObject.save(b,cookie[b],c)}for(var a in cookie){storageObject.save(a,cookie[a],c)}}},save:function(a,c,b){if(useLocalStorage){return localStorage.setItem(a,c)}else{cookie[a]=c;if(c instanceof Object){val=JSON.stringify(c)}else{val=c}return $.cookie(a,val,b)}},load:function(a){if(useLocalStorage){return localStorage.getItem(a)}else{if(cookie[a]){return cookie[a]}var c=$.cookie(a);try{return cookie[a]=JSON.parse(c)}catch(b){return cookie[a]=c}}},remove:function(a){if(useLocalStorage){return localStorage.removeItem(a)}else{return $.removeCookie(a)}},clear:function(){if(useLocalStorage){return localStorage.clear()}else{for(var a in cookie){$.removeCookie(a)}}}};function modalNavigate(b,c,a){modal(b,c,a,{callbacks:{beforeClose:function(){try{location.hash="#!";history.replaceState(null,"",window.location.pathname+window.location.search)}catch(d){}}}})}function getURLParamObject(a){var b,d=/\+/g,c=/([^&=]+)=?([^&]*)/g,g=function(h){return decodeURIComponent(h.replace(d," "))},f=a.substring(1);var e={};while(b=c.exec(f)){e[g(b[1])]=g(b[2])}return e}function initHashRoutes(){var d=function(){var h=currentModal();return h&&h.data.src[0].id!="popup-notfound"};var a=function(h){modal("#popup-notfound",false,true);$("#popup-notfound").find("code.fill-hash").html(h.current)};var e=function(){if(d()){modalHide()}};var f=function(h){};var b=function(h){console.log("[HASH] interpreted",h,this.params)};var g=function(){if(!Path.routes.previous){return true}var h=Path.routes.previous.split("?");var i=location.hash.split("?");return !(h[0].replaceAll("/","")==i[0].replaceAll("/",""))};var c=function(){var i=this.params.id;var h=this.params.restArg;if(!g(h)){return}if(!storageObject.load("mac")){return}modalNavigate("#popup-reply",false,false);clrReplyPopup(true);$("#postreply-id").val(i);getDetailedPost({id:i});if(h){f(h)}b.call(this,"post")};Path.rescue(function(){if(!this.current||this.current=="#!"){e();return}a(this);console.log("[Path/rescue] not found.")});Path.map("#!/post(/:id)/").to(c);Path.map("#!/post(/:id)(/:restArg)").to(c);Path.listen()}function urlData(a,b){return a+"?"+b}function UNKNOWN(a){return TAG("span",COLOR_CLASS.UNKNOWN,a||"???")}function BADGE(a){if(isLevel(a)){return""}return URL_BADGE_BASE+"badge_"+a+"_240.png"}function TAGb(b){var a=badgeSearch(b.badge);if(!a[0]||!a[1]){return""}return TAG("img","shadow-award action-award","src='"+BADGE(b.badge)+"' data-badge='"+b.badge+"' data-subject='"+b.subject+"' data-date='"+b.date+"'","")}function TAGb2(a){var b=BADGE(a);return TAG("a","imglightbox","href='"+b+"' rel='player=img'",TAG("img","shadow-award","src='"+b+"'",""))}function TAGi(a,b){return TAGl(imageLM(a,"m"),imageLM(a,"X"),b,true)}function TAGl(d,e,f,c){e=e||d;if(!c){f=f||160}var b="shadow"+(c?" autoScaleImage":"");var a="src='"+d+"'"+(f?" style='width:"+f+"px;height:"+f+"px'":"");return TAG("a","imglightbox","href='"+e+"' rel='player=img'",TAG("img",b,a,""))}function strUntilInvalid(b,a){var c=b.indexOf(a);return c>0?b.slice(0,c):b}function parseURL(c){var b=document.createElement("a");b.href=c;return{source:c,protocol:b.protocol.replace(":",""),host:b.hostname,port:b.port,query:b.search,file:(b.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1],hash:b.hash.replace("#",""),path:b.pathname.replace(/^([^\/])/,"/$1"),relative:(b.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],segments:b.pathname.replace(/^\//,"").split("/")}}function LINK(b,f){var a=f||b;if(a.length>=70){a=truncateText(a,25)+truncateText(a,-30)}else{a=truncateText(a,40)}var c=["lm.twbbs.org","andy0130tw.qov.tw","learnmode.host22.com"];var d=parseURL(b);if(c.indexOf(d.host)>=0&&(d.path=="/"||d.path==document.path)){var e=d.hash;var g;if(g=/^!\/post\/(.+)/.exec(e)){a=f||("內部貼文 ["+postIdTruncate(g[1])+"]");return TAG("a","","href='#"+e+"'",ICON("tag")+" "+a)}}return TAG("a","","href='"+b+"' target='_blank'",ICON("new-tab-2")+" "+a)}function TABLE(b,a){var f="";for(var e=0;e<b.length;++e){var d="";for(var c=0;c<b[e].length;c++){d+=TAG("td",b[e][c])}if(a){f+=TAG("tr",a(b[e]),d)}else{f+=TAG("tr",d)}}return f}function TABLE_HEADER(a){for(var b=0;b<a.length;++b){a[b]=TAG("th","text-left",a[b])}return TAG("thead",TAG("tr",a.join("")))}function extractDate(a){return new Date(a.getFullYear(),a.getMonth(),a.getDate())}function extractTime(a){return new Date((a.getHours()*3600+a.getMinutes()*60+a.getSeconds())*1000)}function dateGetDays(b){var a=Math.round((extractDate(new Date())-extractDate(b))/86400000);if(a==0){return"今天"}if(a==1){return"昨天"}if(a==2){return"前天"}if(a<=7){return a+"天前"}return false}function imageLM(b,a){return URL_IMAGE+b+(a?"?size="+a:"")}function listitem(d,e,b,a){var c={};if(typeof b=="object"){c=b}else{c={inner:b}}return TAG("div","list post"+(e?" autoheight":"")+(c.outer?" "+c.outer:""),"tabindex='0'"+(a?" data-id='"+a+"'":""),TAG("div","list-content"+(c.inner?" "+c.inner:""),d))}function listitemNull(b,a){return listitem(TAG("p","text-center",TAG("span","subheader-secondary",ICON("comments-5"))+"<br/>"+b))}function thumbitem(c,a,b,d){return TAG("div","image-container cursorhand"+(a?" "+a:""),"data-id='"+d+"'",TAG("img","","src='"+c+"'","")+b)}function processGrid(b,d){var c=[],e=[];var f=function(){e.push(TAG("span","row",c.join("")));c=[]};for(var a in b){c.push(b[a]);if(c.length==d){f()}}if(c.length){f()}return e}function nl2br(a){return a.replace(/\n/g,"<br/>\n")}function urlToLink(b){var a=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|;])/ig;return b.replace(a,function(d,g,e,f,c){return" "+LINK(g)})}function postIdTruncate(a){return a.substring(0,8)}function normalize(a){return a.replaceAll('\\"','"').replaceAll("\\\\","\\").replaceAll("\\'","'").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("ς","　")}function markupContent(a){a=a.replace(/--[ ]*(.+?)[ ]*--/g,"<del>$1</del>").replace(/\*\*[ ]*(.*?)[ ]*\*\*/g,"<strong>$1</strong>").replace(/__[ ]*(.+?)__[ ]*/g,"<u>$1</u>");return a}function processContent(c,a){if(a){var b=smartTrimmer(c);if(b){return nl2br(urlToLink(markupContent(normalize(b))))+TAG("span","text-muted","…(Read More)")}}return nl2br(urlToLink(markupContent(normalize(c))))}function isAnimationSupported(){var a=isAnimationSupported.ans;if(a!==undefined){return a}var d=false,e=$("body")[0],c="Webkit Moz O ms Khtml".split(" ");if(e.style.animationName!==undefined){d=true}if(d===false){for(var b=0;b<c.length;b++){if(e.style[c[b]+"AnimationName"]!==undefined){d=true;break}}}return isAnimationSupported.ans=d}function macConverter(g){g=g.toUpperCase();var d=[],b="",e="_",c=true;for(var a=0;d.length<6;++a){var f=a<g.length?g[a]:e;if(f==e){c=false}if(f==e||(g[a]>="0"&&g[a]<="9")||(g[a]>="A"&&g[a]<="F")){b+=f;if(b.length==2){d.push(b);b=""}}}return{mac:d.join(":"),valid:c}}function extractSubject(c){var b=[];for(var a=0;a<c.length;++a){b.push(c[a].id)}return b}function isMyself(a){if(!myProfile){throw new Error("isMyself, myProfile is not ready!")}return isSameUser(a,myProfile)}function isSameUser(b,a){return b.id==a.id}function needSubject(c){var a=["question","!badge","watch","annotation","course"];for(var b=0;b<a.length;++b){if(c==a[b]){return true}}return false}function getRelationWithUser(a){if(a.is_blocked){if(a.is_blocked_by){return ICON("blocked")+" 互相封鎖"}else{return ICON("blocked")+" 已封鎖他"}}else{if(a.is_blocked_by){return ICON("blocked")+" 已封鎖你"}else{if(a.is_following){if(a.is_followed_by){return ICON("tab")+" 互相關注"}else{return ICON("bars")+" 已關注他"}}else{if(a.is_followed_by){return ICON("bars")+" 已關注你"}}}}return false}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(c,b){if(void 0===this||null===this){throw new TypeError('"this" is null or not defined')}var a=this.length>>>0;for(b=+b||0,1/0===Math.abs(b)&&(b=0),0>b&&(b+=a,0>b&&(b=0));a>b;b++){if(this[b]===c){return b}}return -1}}JSON=JSON||{};if(typeof JSON.parse!=="function"){cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}JSON.stringify=JSON.stringify||function(j){var k=typeof(j);if(k!="object"||j===null){if(k=="string"){j='"'+j+'"'}return String(j)}else{var i,g,l=[],h=(j&&j.constructor==Array);for(i in j){g=j[i];k=typeof(g);if(k=="string"){g='"'+g+'"'}else{if(k=="object"&&g!==null){g=JSON.stringify(g)}}l.push((h?"":'"'+i+'":')+String(g))}return(h?"[":"{")+String(l)+(h?"]":"}")}};