function LMLoader(){var b=this;b.respInfo=null;b.action="";b.lastReq=null;b.target=null;b.dummyContent="";b.clearBefore=false;b.preLoad=null;b.loadFunc=null;b.parse=null;b.render=null;var a=function(d){var c=b.parse(d);b.respInfo=d.info;b.render(c)};b.load=function(c,d){b.clear();b.respInfo=null;b.action=c;b.lastReq=d;var e=b.preLoad();if(e){b.loadFunc(c,d,a)}};b.loadMore=function(){b.clearBefore=false;b.lastReq.before=b.respInfo.oldest;var c=b.preLoad();if(c){b.loadFunc(b.action,b.lastReq,a)}};b.clear=function(){if(b.target===null){throw new Error("LMLoader, no target to clear.")}$('*[data-toggle="popover"]').popover("destroy");if(!b.dummyContent){b.dummyContent=b.target.html()}b.target.html(b.dummyContent)}}var mainLoader=null;$(function(){mainLoader=new LMLoader();mainLoader.loadFunc=loadFromLM;mainLoader.parse=parsePostListView;mainLoader.preLoad=function(){setShow("#main-loading","",false);viewRecognize(this.lastReq,this.clearBefore);if(this.lastReq.category=="__badge"){addToAward(currentProfile.badges);setShow("#main-loading","",true);return false}return true};mainLoader.render=addToContent;mainLoader.target=$("#mainContent")});function parsePostListView(e){var b=e.list;var c=[];for(var a in b){var d=modifyObj(b[a],e);c.push(renderPostListView(d))}if(!c.length){return false}return c.join("")}function parsePostThumbView(e){var c=e.list;var b=[];for(var a in c){b.push(renderPostImageView(modifyObj(c[a],e)))}var d=processGrid(b,4);return TAG("div","grid",d.join(""))}function addToContent(c){var b=new Date();switchEnabled("#btn-loadmore",this.respInfo.more);this.target.append(c);if(c===false){this.target.append(listitemNull("沒有動態可顯示。"))}setShow("#main-loading","",true);addLightbox();var a=new Date();console.log("[addToContent/Render] "+(a-b)+"ms")}var VERSION_MAJOR="1.";var VERSION_MINOR="34";var VERSION_COUNT="";var LAST_MODIFY="2014/4/23";var LOCAL_TEST=(location.hostname=="localhost");var DEBUGGING_ENVIROMENT=(!location.hostname);var URL_PROXY=DEBUGGING_ENVIROMENT?"":(LOCAL_TEST?"proxy.php":"http://andy0130tw.qov.tw/proxy.php");var URL_USERDATA=DEBUGGING_ENVIROMENT?"":(LOCAL_TEST?"":"http://andy0130tw.qov.tw/userdata.php");var URL_LM="https://apollo.omcompany.com:5443/api/";var URL_IMAGE="https://apollo.omcompany.com:5443/image/";var URL_BADGE_BASE="/res/image/badge/";var URL_HST="http://lmadmin.learnmode.net/api/v1/";var URL_SEARCH="https://mercury.omcompany.com:5443/";var SPLASH_OFF_DURATION=2500;var FX_VIEW_DURATION=1000;var FX_BRING_TOP_DURATION=400;var NOTIFY_TIME={SHORT:3000,MEDIUM:7000,LONG:10000};var YOUTUBE_REGEX=/v=([\w\-]*).*/i;var COUNT={HOMEPAGE:40,NOTIFICATION:50,REPLY:25,HOT:100,ANNOUNCEMENT:10,USER:30,USER_SEARCH:20,USER_BADGE:10,MOOD:30,VOTER:30,ALBUM:24,PIN:3};var COLOR_CLASS={APPLICATION:"text-muted list-small",SCHOOL:"text-muted list-small",VOTE:"fg-amber",EMOTION:"fg-pink",FOLLOW:"text-success",BADGE:"text-warning",VOTE_BD:"bd-amber",EMOTION_BD:"bd-pink",FOLLOW_BD:"bd-green",BADGE_BD:"bd-orange",UNKNOWN:"text-warning",RM_HINT:"text-warning action-reveal-rm",RM_REVEALED:"text-alert",LABEL_ACTIVE:"fg-cobalt",PARSE_ERROR:"text-alert"};var TEXT_RETURN_ALT=" "+TAG("small","text-pilcrow",ICON("pilcrow"));var valueOrOriginal=function(a,b){return b[a]||a};var HASH={levelName:{novice:["初學者",1],progress:["大進步",2],self_learner:["自動自發",3],advancer:["加速前進",4],smart:["聰明狂人",5],enthusiast:["狂熱主義",6],senior:["資深學人",7],talent:["才能高超",8],innovator:["改革創新",9],researcher:["研究生",10],influencer:["影響家",11],motivator:["激勵領袖家",12],unbeatable:["所向無敵",13],master:["名家大師",14],guru:["權威人士",15],professor:["專家教授",16]},replyParser:{share:{category:"comment",application:"reading",mood:true,allowImage:true},question:{category:"answer",application:"reading",mood:false,allowImage:true},scrapbook:{category:"comment",application:"scrapbook",mood:true,allowImage:false},watch:null,_none:{category:undefined,application:undefined,mood:false,allowImage:false,none:true}},badgeName:{explorer:["探險家",["於Books應用程式中閱讀","一頁+10分|累計30頁+15分"],[1000,5000,15000]],scout:["影武者",["於YouTube中觀看在LM分享的影片","一部+10分|累計30部+15分"],[1000,5000,15000]],vanguard:["好學士",["於Practice應用程式中完成考試","一次考試+10分|成績高於90分+15分|累計3次+15分"],[1000,5000,15000]],upgrader:["助力士",["還不知道。","有賴活躍者提供。"],[500,3000,12000]],connector:["博學家",["於Books應用程式中新增註解","每則+3分"],[500,3000,12000]],generator:["學問星",["提出問題","每則+3分"],[1000,5000,12000]],trailblazer:["善答星",["回答問題","每題問題+2分"],[500,3000,12000]],validator:["讚讚星",["對回答進行評分","???"],[500,3000,12000]],apprentice:["實習生",["登入","每天+1分|同日登入不重複計算"],[30,80,200]],lodestar:["北極星",["被其他人關注","每人+1分|解關注我不知道會不會減少"],[30,80,200]],visionary:["夢想家",["發表貼圖","每則+3分"],[200,1500,3000]],discoverer:["發現家",["發表貼文","每則+1分"],[500,4000,8000]],touchstone:["感動家",["甩表情","每個+1分"],[200,1500,3000]],catalyst:["催化劑",["對貼文或貼圖發表評論","每則+1分"],[200,1500,3000]]},badgeLevel:{bronze:"銅牌",silver:"銀牌",gold:"金牌"},mood:["","熱愛","喜歡","無評論","討厭","憤怒"],exception:{timeout:{txt:"連線逾時",fatal:true},abort:{txt:"連線被取消",fatal:true},error:{txt:"其他錯誤",fatal:true},parsererror:{txt:"資料解析失敗",fatal:true}},failureTranslation:{"cannot follow oneself":"不能關注自己","empty message":"訊息不能為空","invalid parameters":"參數無效",blocked:"已被封鎖，無法執行","record not exist":"此紀錄不存在"}};var SUBJECT_MAP={10001:"建築",10002:"城市設計",10003:"藝術",10004:"媒體藝術",10005:"世界藝術與文化/舞蹈",10006:"設計",10007:"攝影",20001:"商業經濟",20002:"產業組織",20003:"統計與經濟計量",20004:"核心財務",20005:"估值和投資",20006:"風險投資和資本市場",20007:"銀行和貨幣",20008:"會計",20009:"工商管理",20010:"市場營銷",20011:"創業研究",30001:"媒體",30002:"媒體製作",30003:"傳播學",30004:"廣播",30005:"公關",30006:"辯論",30007:"電影",40001:"航空航天工程",40002:"大氣，海洋和空間科學",40003:"化學工程",40004:"土木與環境工程",40005:"電氣工程",40006:"工業工程",40007:"材料科學",40008:"機械工程",40009:"造船學",40010:"核工程與放射科學",50001:"健康研究",50002:"病理生理學",50003:"醫藥學",50004:"基因組學",50005:"藥理學",50006:"神經學",50007:"內分泌學",50008:"血液學",50009:"胃腸學",50010:"分子科學",60001:"寫作技巧",60002:"英語語言文學",60003:"比較文學",60004:"中國文學",60005:"美國劇院和戲劇",60006:"詩",60007:"編劇",70001:"算術",70002:"代數基礎",70003:"代數",70004:"幾何",70005:"三角",70006:"機率",70007:"統計",70008:"微積分基礎",70009:"微積分",70010:"微分方程式",70011:"線性代數",80001:"通識教育",80002:"邏輯",80003:"哲學史",80004:"倫理學與價值理論",80005:"認識論",80006:"現象學",90001:"生物學",90002:"化學",90003:"有機化學",90004:"物理",90005:"宇宙學和天文學",90006:"計算機科學",90007:"地理",100001:"音樂教育",100002:"編曲",100003:"音樂劇",100004:"戲劇和戲曲",100005:"音樂理論",100006:"木管樂器",100007:"打擊樂器",100008:"聲樂方法",100009:"樂隊管理",100010:"銅管樂器",110001:"歷史研究",110002:"中東史",110003:"亞洲史",110004:"歐洲史",110005:"美國歷史",110006:"拉丁美洲歷史",110007:"史前研究",120001:"政治學",120002:"民主理論",120003:"農業法",120004:"憲制性法律",120005:"財政和金融法",120006:"國際法",120007:"勞動和社會法",120008:"政治理論",120009:"國際關係",120010:"比較政治學",130001:"個性學",130002:"發展心理學",130003:"認知心理學",130004:"社會心理學",130005:"健康心理學",130006:"Pavlovian過程",140001:"佛教",140002:"古蘭經",140003:"禪：歷史，文化與批判",140004:"猶太人的視覺文化",140005:"世界宗教：中東",150001:"社會學的原理和存在",150002:"社會學理論",150003:"犯罪學",150004:"社會學視角",150005:"個人行為",150006:"社會正義，多樣性，認同，和社區",150007:"性別社會學",150008:"服務學習",160001:"運動訓練",160002:"運動科學",160003:"體育教育",160004:"體育管理",160005:"臨床經驗",160006:"體育財經",170001:"教育與心理",170002:"人類發展",170003:"多元文化的社會基礎",170004:"掃盲發展",170005:"教學方法",180001:"中文",180002:"英語",180003:"日文",180004:"法文",180005:"德語",180006:"阿拉伯語",180007:"西班牙文"};var SUBJECT_CATEGORY_NAME=["藝術、設計","經濟","通訊","工程","醫學","文學","數學","哲學","科學","音樂與戲劇","歷史","法律與政治","心理學與社會科學","宗教","社會與文化","運動","教育","語言"];var randomTip=["隨機小提示全部重新寫過了！重新整理可以看到另一些提示喔。","LM Textbook 已經因版權的緣故終止服務了，哭哭。","Flyer內建的瀏覽器有時候會跑不出小圖示。舉例來說：["+ICON("database")+"]。","程式碼破三千行、十萬字了，如果能寫小說有多好。","這個網頁常常在更新啊。懷疑是不是最新版的話，整個網頁重新整理一次就知道了。","用網頁版留言的附帶優惠，是計算機科學的等級會升級。","這網頁的圖標是 皮 用 InkScape 做的。","剪貼簿的另外一種瀏覽方式在整個網頁的右上角，不知道有沒有人用(嘀咕)。","最近一直在幫網頁的程式碼瘦身，可能會發生一點意外吧？！","這網頁在Flyer預設瀏覽器的效能問題，一直是惡夢。","關注/解關注常常會很遲鈍，這是伺服器的問題，耐心等待吧。","想不到 Tips 了... 請常逛作者開發樓吧。","小螢幕和大螢幕會有好多地方不一樣，這都是為了在有限的視窗中擺放最適合的內容，所精心(?)調整而成。"];function experimental(c){if(c==1){var b=["share","question","scrapbook","comment","watch"];for(var d=b.length-1;d>=0;d--){RENDER_ENG.category1[b[d]].reactFN=renderVoteButton}alert("強制玄奇樓已設置。網頁重新整理後會失效。")}else{if(c==2){postIfBlock(0,1)}else{if(c==3){postIfBlock(0,0)}else{if(c==4){var a=window.USE_MOBILE_RULE=!window.USE_MOBILE_RULE;localStorage.setItem("use-mobile",a?"true":"");alert("嘗試使用平板簡易模式：現在起"+(a?"啟用":"停用")+"。\n網頁重新整理不會失效，若要取消請重新選用此項。")}else{alert("無效的實驗功能！")}}}}return false}function overrideAJAX(){$.ajaxPrefilter(function(a,c,b){c._error=c.error;a.error=function(d,f,e){if(c._autoRetry){console.log("[overrideAJAX] AutoRetry, option:",c);$.ajax(c)}else{if(c._error){c._error(d,f,e)}}}})}function loadFromLM(d,c,e,a,b){c=c||{};if(!c.device){c.device=cookieObject.load("mac")}return $.ajax({url:urlParam(URL_LM+d,c),dataType:"jsonp",timeout:40000,success:function(f){if(f.status=="ok"){e(f)}else{if(a){a(f.message)}var g=valueOrOriginal(f.message,HASH.failureTranslation);notify.connectFailure("載入資料失敗 from LM!<br/>訊息: *** "+g+" ***")}},error:function(g,h,f){if(h=="abort"){notify.abort("嘗試重新整理中...",3000);return}notify.connectFailure("無法與 LM 連線!<br/>錯誤訊息: "+HASH.exception[h].txt)},_autoRetry:b})}function loadFromProxy(b,a,c){if(!URL_PROXY){notify.verbose("目前環境下無法使用 Proxy.<br/>視為請求成功。");c(null);return}a.action=b;return $.ajax({url:urlParam(URL_PROXY,a),data:a,dataType:"jsonp",timeout:50000,success:function(d){if(d.status.http_code=="200"){c(d.contents)}else{notify.error("載入資料失敗 from Proxy!<br/>資料無效.")}},error:function(e,f,d){if(f=="parsererror"){return}if(f.fatal){notify.connectFailure("無法與 Proxy 連線!<br/>錯誤訊息："+HASH.exception[f].txt)}}})}function postProxy(b,a,c){if(!URL_PROXY){notify.verbose("目前環境下無法使用 Proxy.<br/>視為請求成功.");c(null);return}a=a||{};return $.ajax({url:urlParam(URL_PROXY,{action:b}),type:"POST",data:a,processData:false,contentType:false,success:function(g){if(g.status.http_code==200){var f=g.contents;var d=f.indexOf("\r\n\r\n")+4;var e=f.lastIndexOf("}")+1;resp_obj=JSON.parse(f.substring(d,e));resp_obj._status=g.status;console.log("Post Success: ",resp_obj);if(resp_obj.status=="error"){var h=valueOrOriginal(resp_obj.message,HASH.failureTranslation);notify.error("POST 已成功執行, 但是結果似乎不對.<br/>訊息:<br/>"+h)}else{c(resp_obj)}}else{var f=g.contents.replaceAll("|","<br/>");notify.error("POST 執行失敗!<br/>HTTP Code: "+g.status.http_code+"<br/>訊息:<br/>"+f)}},error:function(e,f,d){if(f.fatal){notify.connectFailure("POST 至 LM 失敗!<br/>錯誤訊息: "+HASH.exception[f].txt)}}})}function loadUserdata(b,a,c){if(!URL_USERDATA){notify.verbose("目前環境下無法使用 Userdata.<br/>視為請求成功.");c(null);return}a=a||{};a.action=b;if(!a.mac){a.mac=cookieObject.load("mac")}return $.ajax({url:urlParam(URL_USERDATA,a),dataType:"jsonp",timeout:40000,success:function(d){if(d.status.http_code==200){c(d.content)}else{notify.connectFailure("載入資料失敗 from Userdata!<br/>資料無效: "+d.content)}},error:function(e,f,d){notify.connectFailure("無法與 Userdata 連線!<br/>錯誤訊息: "+HASH.exception[f].txt)}})}function postUserdata(c,b,d){if(!URL_USERDATA){notify.verbose("目前環境下無法使用 Userdata.<br/>視為請求成功.");d(null);return}var a={action:c,mac:cookieObject.load("mac")};b=b||{};return $.ajax({url:urlParam(URL_USERDATA,a),type:"POST",data:b,processData:false,contentType:false,success:function(f){if(f.status.http_code==200){var e=f.content;if(f.status=="ERROR"){notify.error("POST 已成功執行, 但是結果似乎不對.<br/>Message: "+e)}d(f)}else{notify.error("Post Failed!<br/>HTTP Code: "+f.status.http_code+"<br/>Message: "+f)}},error:function(f,g,e){if(g.fatal){notify.connectFailure("POST 至 LM 失敗!<br/>錯誤訊息: "+HASH.exception[g].txt)}}})}var dummyContent;var lastestEntryID="";var lastestAnnouncementID="";var usersMoreFN=function(){};var lastestUsersID="";var SUBJECT=[];var userProfile;var currentProfile;function readProfile(a){loadFromLM("profile/read",a,doLogin,doLoginFailure)}function readUserProfile(a){assert(a.user,"readUserProfile","id is missing.");loadFromLM("profile/read",a,function(b){userProfile=b.profile;addToUserLightbox()})}function listAnnouncement(b,a){if(a){$("#announcement-body").empty()}loadFromLM("announcement/list",b,addToAnnouncementPopup);return b}function getDetailedPost(a,b){if(b){loadFromLM("read",a,parseMood)}else{setShow("#reply-loading","#reply-ok",false);loadFromLM("read",a,parseReply);getDetailedMood({id:a.id,count:COUNT.MOOD})}}function getDetailedMood(a){detailedMood=[];switchClass(".moodlightbox","success",false);switchEnabled(".moodlightbox",false);loadFromLM("mood/list",a,parseDetailedMood)}function getRelated(b){assert(b.id,"getRelated","The request might be unsent.");var c={};for(var a in b){if(a=="id"){c.related=b.id}else{c[a]=b[a]}}c.sort=c.sort||replyObject._sort;assert(c.sort,"getRelated","Sort not given.");c.count=COUNT.REPLY;loadFromLM("list",c,addToReplyPopup)}function getVoter(a){loadFromLM("vote/list",a,function(e){voter=new Array(2);voter[0]=[];voter[1]=[];for(var b in e.list){var d=e.list[b];var c=e.users[d.user];c._vote_date=d.date;if(d.vote=="up"){voter[0].push(c)}else{if(d.vote=="down"){voter[1].push(c)}}}addToVoterLightbox()})}function getPinList(){loadUserdata("load",{},initPinList)}function refreshReply(){clrReplyPopup();replyObject._newest=undefined;replyObject._sort="date";getRelated({id:replyObject.id})}function sortReplyByScore(){clrReplyPopup();replyObject._newest=undefined;replyObject._sort="score";getRelated({id:replyObject.id})}function sortReplyReverse(){clrReplyPopup();replyObject._newest=undefined;replyObject._sort="subject";getRelated({id:replyObject.id})}function modifyObj(d,b,c){var e=new Date();if(c=="announcement"){d._user=b.users[d.uid]}else{d._user=b.users[d.from]}if(b.related){d._related=d.related?b.related[d.related]:null;d._related_user=d.related?b.users[d._related.from]:null}if(d.voters){for(var a=0;a<d.voters.length;++a){d.voters[a]=b.users[d.voters[a]]}}return d}function addToAnnouncementPopup(d){var b=d.list;lastestAnnouncementID=d.info.oldest;switchEnabled("#btn-loadmore-announcement",d.info.more);for(var a in b){var c=modifyObj(b[a],d,"announcement");$("#announcement-body").append(renderAnnouncement(c))}setShow("#announcement-loading","",true);addLightbox()}function addToUsersPopup(e){setShow("#users-loading","#users-ok",true);var c=e.list,d=e.users;lastestUsersID=e.info.oldest;switchEnabled("#btn-loadmore-users",e.info.more);if(d.length==0){$("#users-body").append(listitemNull("查無結果..."))}for(var a in c){var b=d[c[a].user];b._badge=c[a].badge;b._subject=c[a].subject;b._date=c[a].date;$("#users-body").append(renderUserListView(b))}}function addToReplyPopup(f){var c=f.list;replyObject._oldest=f.info.oldest;if(!replyObject._newest){replyObject._newest=f.info.newest}if(f.list[0]){var d=f.list[0].related;if(pinList[d]&&pinList[d].unread){console.log("[addToReplyPopup] cleared");clearUnread(d);postSavePinList()}}switchEnabled("#btn-loadmore-reply",f.info.more);if(c.length==0){$("#reply-content").html(listitemNull("還沒有回應。"))}for(var b in f.list){var e=modifyObj(c[b],f);$("#reply-content").append(renderPostListView(e,true))}finishReplyPopup()}function finishReplyPopup(){addLightbox();setShow("#reply-loading","#reply-ok",true);setShow("#reply-content-loading","",true);checkPinPostButton()}var replyObject={};function parseMood(d){d=modifyObj(d.list[0],d);for(var b=0;b<6;++b){var c=$("#reply-mood button");var a=c.children("small").eq(b);switchClass(c.eq(b),"inverse",(b==d.my_mood-1||(b==5&&d.my_mood==0)));if(b<5){a.html(d.moods[b])}}}function parseDetailedMood(e){detailedMood=new Array(5);for(var c=0;c<5;++c){detailedMood[c]=[]}for(var a in e.list){var d=e.list[a];var b=e.users[d.user];b._mood_date=d.date;if(d.mood>0){detailedMood[d.mood-1].push(b)}}switchClass(".moodlightbox","success",true);switchEnabled(".moodlightbox",true)}function parseReply(a){replyObject=modifyObj(a.list[0],a);replyObject._sort="date";$("#reply-body").html(renderCompactPost(replyObject));addLightbox();parseMood(a);var b=HASH.replyParser[replyObject.category]||HASH.replyParser._none;switchVisible("#reply-accordion,#reply-tool,#reply-content,#reply-bottom",!b.none);switchVisible("#reply-mood,.moodlightbox",b.mood);switchVisible(".action-refresh-by-score",replyObject.category=="question");switchVisible("#postreply-file-uploader",b.allowImage);replyObject._replyBase=b;if(!b.none){$(".panel-header").children("span").eq(1).html(a.list[0].ref_count);getRelated({id:a.list[0].id})}else{finishReplyPopup()}}var badgeObj={};function addToAward(f){switchEnabled("#btn-loadmore",false);var q=[];var a=[],d={};var h=0;badgeObj={};for(var r in f){var m=f[r];if(isLevel(m.badge)){var o=HASH.levelName[m.badge];var l=m.subject;var p=SUBJECT_MAP[m.subject];if(typeof m.subject=="string"){l+="@@@";p=TAG("span","fg-emerald",ICON("film"))+" "+p}else{p=TAG("span","fg-indigo",ICON("feed"))+" "+p}var c=d[l];if(!c||o[1]>=c[1]){d[l]=[p,o[1],o[0],new Date(m.date)]}}else{var k=m.badge.split("_");var s=k[0]+m.subject;var n=badgeObj[s];h++;badgeObj[s]=badgeObj[s]||[];badgeObj[s].push(m)}}for(var r in badgeObj){badgeObj[r].sort(function(t,i){return compareBadgeLevel(t.badge.split("_")[1],i.badge.split("_")[1])});q.push(renderAward(badgeObj[r][badgeObj[r].length-1]))}var j=processGrid(q,4);$("#mainContent").append(TAG("h2","獎章 "+TAG("small","x"+h+" (只會顯示最高位階)"))+TAG("div","grid fluid",j.join("")));for(var r in d){a.push(d[r])}a.sort(function(t,i){return i[3]-t[3]});for(var g=0;g<a.length;++g){a[g][3]=dateConverter(a[g][3])}var e=["科目","等級","等級名稱","獲得日期"];$("#mainContent").append(TAG("h2","等級"+TAG("small"," x"+a.length))+TAG("table","table fill-level hovered",TABLE_HEADER(e)+TABLE(a)))}function clrReplyPopup(a){if(a){$("#reply-body").empty()}$("#reply-content").empty();replyObject._oldest="";switchEnabled("#btn-loadmore-reply",false)}function clrUsersPopup(){$("#users-body").empty();lastestUsersID="";switchEnabled("#btn-loadmore-users",false)}function postShareForm(){var f=new FormData();var g=$("#postshare-file-image")[0];var e="com.htc.learnmode";var b=$("#postshare-category").val();var a=String($("#postshare-url").val());var d=$("#postshare-message").val();if(!d&&confirm("要清空圖片欄位嗎？")){$("#postshare-form")[0].reset();return}var j=function(){f.append("url",a);j=null};if(b=="scrapbook"){if(!g.files[0]){alert("剪貼簿必須要有圖片才可發佈。");return}if(a){j();e="com.android.browser"}}else{if(b=="watch"){if(!a){alert("觀看影片必須要有影片網址，且目前只支援YouTube。");return}else{var k="",i=YOUTUBE_REGEX.exec(a);if(i){k=i[1]}else{var h=a.split("/");k=h[h.length-1];var m=confirm("偵測到影片的ID為[ "+k+" ]，正確嗎？");if(!m){return}}f.append("title",d.split("\n")[0]);a="http://m.youtube.com/#/watch?v="+k;j()}e="browser"}}f.append("device",cookieObject.load("mac"));f.append("message",$("#postshare-message").val());f.append("application",e);f.append("category",b);var l=$(".postshare-subject option:selected").map(function(){return this.value}).get();if(!l.length){if(b=="watch"){l=[10001,10004,30007]}}f=appendSubject(f,l);if(g.files&&g.files[0]&&b!="watch"){f.append("image",g.files[0])}setShow("#postshare-ok","#postshare-processing",true);postProxy("postNotify",f,function(c){modalHide();notify.complete({message:"貼文發佈成功！",status:c?c._status:{}});$("#postshare-form")[0].reset();postshareCategoryChange();changeSubjectSelection();$("#btn-refresh").click()})}function postReplyForm(){var c=$("#postreply-message").val();if(!c&&confirm("要清空圖片欄位嗎？")){$("#postreply-form")[0].reset();return}$("#reply-ok .panel-content").slideToggle();$("#reply-accordion").toggleClass("collapsed");var b=new FormData();b.append("device",cookieObject.load("mac"));b.append("message",c);b.append("category",replyObject._replyBase.category);b.append("application",replyObject._replyBase.application);b.append("related",replyObject.id);b=appendSubject(b,extractSubject(replyObject.subjects));var a=$("#postreply-file-image")[0];if(a.files&&a.files[0]){if(replyObject._replyBase.allowImage){b.append("image",a.files[0])}}postProxy("postNotify",b,function(d){notify.complete({message:"回應發佈成功！",status:d._status});$("#postreply-form")[0].reset();refreshReply()})}function appendSubject(c,a){for(var b=0;b<a.length;++b){c.append("subject[]",a[b])}return c}function postMood(a){var b=new FormData();b.append("device",cookieObject.load("mac"));b.append("mood",a);b.append("id",$("#postreply-id").val());postProxy("postMood",b,function(c){notify.info("甩表情成功！");getDetailedPost({id:$("#postreply-id").val()},true)})}function postVote(b,c){assert(c,"postVote","id is missing.");var a=new FormData();a.append("device",cookieObject.load("mac"));a.append("vote",b);a.append("id",c);postProxy("postVote",a,function(f){var d=f.message;var e={up:ICON("thumbs-up"),down:ICON("thumbs-down"),clear:"清除評分"};notify.info(e[d]+"成功！<br/>PS. 評分情形要重新整理後才會更新。")})}function postIfFollow(a,b){var c=new FormData();c.append("device",cookieObject.load("mac"));c.append("user",a);if(b){postFollow(c,a)}else{postUnfollow(c,a)}}function postFollow(b,a){postProxy("followUser",b,function(c){notify.info("成功關注！");readUserProfile({user:a})})}function postUnfollow(b,a){postProxy("unfollowUser",b,function(c){notify.info("成功解除關注！");readUserProfile({user:a})})}function BLOCK_CAUTION_MAKER(b,c){if(typeof c=="undefined"){alert("Syntax: postIfBlock(a,b), \n a is ignored, and b is your decision.");return false}var a="這是一個本網頁未實作的功能，\n可以利用這個函式來封鎖/解除封鎖某人。\n進入該人的大聲公之後呼叫此函式即可。\n\n";if(isMyself(b)){alert(a+"你想對你自己做什麼？");return false}return confirm(a+"你想要"+(c?"":"解除")+"封鎖 "+b.name+" 嗎？")}function postIfBlock(a,c){if(!BLOCK_CAUTION_MAKER(currentProfile,c)){return}var d=new FormData();var b=currentProfile.username;d.append("device",cookieObject.load("mac"));d.append("user",b);(c?postBlock:postUnblock)(d,b)}function postBlock(b,a){postProxy("blockUser",b,function(c){notify.info("成功封鎖！");readUserProfile({user:a})})}function postUnblock(b,a){postProxy("unblockUser",b,function(c){notify.info("成功解除封鎖！");readUserProfile({user:a})})}function postSavePinList(){var c=new FormData();var b={};for(var a in pinList){if(pinList[a]){b[a]=pinList[a]}}pinList=b;c.append("data",JSON.stringify(pinList));postUserdata("save",c,function(d){if(d){console.log("[postSavePinList] sync status="+d.content)}})}var RENDER_ENG={category1:{share:{label:"愛分享",base:"分享了一篇#貼文#。",scoreFN:renderScore,buttonLabel:"評論",contentFN:renderContent,reactFN:NULL},question:{label:"大哉問",base:"提出了一個#問題#。",scoreFN:renderScore,buttonLabel:"回答",contentFN:renderContent,reactFN:NULL},scrapbook:{label:"剪貼簿",base:"在剪貼簿上新增一則#貼圖#。",scoreFN:renderScore,buttonLabel:"評論",contentFN:renderContent,reactFN:NULL},comment:{label:"評論",base:"回應了%%%的#&&&#。",scoreFN:NULL,buttonLabel:"觀看",contentFN:renderContent,reactFN:NULL},answer:{label:"回答",base:"回答了%%%所提的#&&&#。",scoreFN:renderVote,buttonLabel:"觀看",contentFN:renderContent,reactFN:renderVoteButton},course:{label:"課程",base:"在#Course#上的動態。",scoreFN:NULL,buttonLabel:"讀取",contentFN:renderContent,reactFN:NULL},annotation:{label:"Textbook/Practice",base:"在#Textbook#上新增了一則註解。",scoreFN:NULL,buttonLabel:"讀取",contentFN:renderContent,reactFN:NULL},practice:{label:"Practice",base:"在#Practice#上完成了一次考試。",scoreFN:NULL,buttonLabel:"讀取",contentFN:renderContent,reactFN:NULL},tutor:{label:"講座",base:"分享了一篇#講座#(已廢棄，只有早期貼文會出現)",scoreFN:renderScore,buttonLabel:"評論",contentFN:renderContent,reactFN:NULL},watch:{label:"觀看影片",base:"看了一部#影片#。",scoreFN:NULL,buttonLabel:"讀取",contentFN:renderWatch,reactFN:NULL}},category2:{"!follow":{label:"關注",scoreFN:NULL,buttonLabel:"",contentFN:NULL,reactFN:NULL},"!emotion":{label:"甩表情",scoreFN:NULL,buttonLabel:"觀看",contentFN:NULL,reactFN:NULL},"!badge":{label:"等級/獎牌",scoreFN:NULL,buttonLabel:"",contentFN:renderBadgeImage,reactFN:NULL},"!vote":{label:"評分",scoreFN:NULL,buttonLabel:"觀看",contentFN:NULL,reactFN:NULL},watch:null}};var RELATED_CATEGORY={share:"貼文",scrapbook:"貼圖",question:"問題"};function renderPost(d,g){try{var b="",f={};var a=d._user;if(f=RENDER_ENG.category1[d.category]){b=(!g?renderButton(d,f.buttonLabel):"")+f.scoreFN(d)+f.reactFN(d)+renderAvatar(a)+renderUser(d)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,a.school)+"&nbsp;"+(!g?renderAbstract(d):"")+renderApplication(d)+"<br/>"+TAG("span","list-datetime",renderSSTitle(d))+f.contentFN(d)+renderURI(d)+(d.image?TAGi(d.image):"")}else{if(f=RENDER_ENG.category2[d.category]){b=(!g?renderButton(d,f.buttonLabel):"")+renderAvatar(a)+renderUser(d)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,a.school)+"&nbsp;"+TAG("span",compactMsg(d))+"<br/>"+TAG("span","list-datetime",dateConverter(d.date))+"<br/>"+f.contentFN(d)+renderURI(d)}else{b=(!g?renderButton(d,""):"")+renderScore(d)+renderAvatar(a)+renderUser(d)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,a.school)+TAG("span","text-muted list-small"," @ "+(d.application||"---"))+TAG("span","text-info list-small","&nbsp;&nbsp;&nbsp;"+("?: "+d.category))+"<br/>"+TAG("span","list-datetime",dateConverter(d.date))+"<br/>"+TAG("span","list-title text-alert","UNKNOWN CATEGORY:"+d.category+". Raw JSON dump:")+TAG("span","list-remark",JSON.stringify(d))}}return b}catch(c){notify.warning('有貼文無法正確排版! <br/>請截圖貼到 "功能表->作者開發樓" 協助回報這個錯誤, 謝謝! <br/>'+c.toString());return TAG("p",COLOR_CLASS.PARSE_ERROR,"ERROR occured in renderPost: "+c.toString())+d}}function renderPinPost(d){try{var b="",a=d._user;d.message=truncateText(d.message.replaceAll("\n"," "),70);b=renderButton(d,"詳細")+TAG("span","label fill-count place-right","...")+renderAvatar(a)+renderUser(d)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,a.school)+"&nbsp;："+renderApplication(d)+"<br/>"+TAG("span","list-datetime",renderSSTitle(d))+renderContent(d)+(d.image?TAGi(d.image,60):"");return b}catch(c){notify.warning('追蹤列表無法正確排版! <br/>請截圖貼到 "功能表->作者開發樓" 協助回報這個錯誤, 謝謝! <br/>'+c.toString());return TAG("p","text-warning","ERROR occured in renderPost: "+c.toString())+d}}function renderPinPostReply(c){var b="",a=c._user;c.message=truncateText(c.message.replaceAll("\n"," "),20);b=renderAvatar(a,"inline")+renderUser(c)+"&nbsp;"+TAG("span","text-muted list-small",a.school)+"："+c.message;return b}function renderAnnouncement(c){var a=c._user;var b=renderAvatar(a)+renderUser(c)+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,a.school)+"<br/>"+TAG("span","list-datetime",dateConverter(c.date))+"<br/>"+renderContent(c)+(c.image?TAGi(c.image):"")+renderURI(c);return listitem(b)}function renderCompactPost(a){return renderPostListView(a,true)}function renderWatch(e){var d=YOUTUBE_REGEX.exec(e.url);var b=d?("http://www.youtube.com/embed/"+d[1]+"?autoplay=1&rel=0"):e.url;var a=e.message.split("\n");var f=a.shift();var c=a.join("\n");return TAG("span","list-title",TAG("p",f)+processContent(c)+"<br/>"+TAG("blockquote","",ICON("right-quote")+" 影片："+LINK(b,e.title)))}function renderUser(a){return renderUserRaw(a._user)}function renderUserRaw(a,b){if(b){b=b.replace("%%%",a.name)}if(a.roles[0]=="teacher"){return TAG("strong","userlightbox bd-indigo","data-id='"+a.username+"' style='border:3px dotted;'",b||a.name)}return TAG("strong","userlightbox","data-id='"+a.username+"'",b||a.name)}function renderAvatar(b,a){return renderAvatarRaw(b,"icon shadow userlightbox"+(a?" "+a:""))}function renderAvatarRaw(b,a){return TAG("img",a,"src='"+imageLM(b.image)+"' data-id='"+b.username+"'","")}function renderVoteButton(a){class1=a.my_vote=="up"?"success":"inverse";class2=a.my_vote=="down"?"warning":"inverse";return renderButtonRaw(ICON("thumbs-down"),"place-right bg-hover-gray action-vote-down "+class2,a.id)+renderButtonRaw(ICON("thumbs-up"),"place-right bg-hover-gray action-vote-up "+class1,a.id)}function NULL(){return""}function renderApplication(a){if(a.category!="scrapbook"){return""}return TAG("span",COLOR_CLASS.APPLICATION," @ "+(a.application))}function renderContent(g){if(g.category=="course"){var f=/(對)(.+)(課程的評分為)(.+)/;var e=/(對)(.+)(課程，有以下的意見,)'(.+)'/;g.message=g.message.replace(f,"$1"+TAG("strong"," $2 ")+"$3"+TAG("strong"," $4 "));g.message=g.message.replace(e,"$1"+TAG("strong"," $2 ")+"$3<br/>$4");return TAG("span","list-title",g.message.replaceAll("_"," "))}else{if(g.category=="practice"){var d=/(考完)(.+)(的試卷)/;g.message=g.message.replace(d,"$1"+TAG("strong"," $2 ")+"$3");var b=/(,獲得)(.+)(分)/;g.message=g.message.replace(b,"$1"+TAG("strong"," $2 ")+"$3");return TAG("span","list-title",g.message.replaceAll("_"," "))}}var c="list-title";var a=processContent(g.message);if(g.flagged){return TAG("strong",c+" "+COLOR_CLASS.RM_HINT,"data-rm='"+g.id+"'",ICON("blocked")+" Removed by Moderator，點此觀看。")}if(g.message=="　"||g.message==" "){c+=" empty"}if(g._flagged){c+=" "+COLOR_CLASS.RM_REVEALED;a=ICON("unlocked")+" <strong>[RM Revealed!]</strong><br/>"+a}return TAG("span",c,a)}function renderURI(g){var c=g.url;if(!c||c.match(/:\/\/$/)||g.category=="practice"||g.category=="watch"){return""}if(c.indexOf("course:")==0){var f=c.match(/id=(.+)&chapterId=(.+)/);if(!f){return""}var b="http://course.learnmode.net/upload/video_"+f[2]+".mp4?direct=1";return TAG("blockquote",ICON("camera-2")+" Course 課程影片："+LINK(b,"Course #"+f[2]+" (ID="+f[1]+")"))}else{if(c.indexOf("textbook:")==0){var e=c.match(/textbook:discussion=(.+)&page=(.+)/);if(!e){return""}var a="http://textbook01.learnmode.net/upload/"+e[1]+".pdf?direct=1#page="+e[2];return TAG("blockquote",ICON("book")+" Books 書籍PDF："+LINK(a,"Books #"+e[1]+" (第 "+e[2]+" 頁)"))}else{if(c.indexOf("content://")==0){var d=c.match(/com.htc.learnmode\/(.+)\/(.+)/);if(!d){return""}return TAG("blockquote",ICON("tag")+" 跳至貼文："+TAG("span","action-reply text-info pseudolink","data-id='"+d[2]+"'",RENDER_ENG.category1[d[1]].label))}else{if(c.indexOf("http")==0){return TAG("blockquote",ICON("right-quote")+" 網頁："+LINK(c))}}}}return TAG("blockquote",c+" (Can't be interpreted yet)")}function renderSubject(e,c){var b=[],a=e.subjects.length;for(var d=0;d<a;++d){b.push(SUBJECT_MAP[e.subjects[d].id]);if(d+1==c&&a-b.length>1){b.push("...("+(a-b.length)+")");break}}return b}function renderPostListView(b,c){var a="";if(b.category=="!follow"){a={inner:COLOR_CLASS.FOLLOW_BD,outer:"follow-outer"}}else{if(b.category=="!emotion"){a={inner:COLOR_CLASS.EMOTION_BD,outer:"emotion-outer"}}else{if(b.category=="!vote"){a={inner:COLOR_CLASS.VOTE_BD,outer:"vote-outer"}}else{if(b.category=="!badge"){a={inner:COLOR_CLASS.BADGE_BD,outer:"badge-outer"}}}}}return listitem(renderPost(b,c),!c,a)}function renderPinPostInner(a){return TAG("div","list-content",renderPinPost(a))}function renderPostImageView(a){return thumbitem(imageLM(a.image,"l"),"action-reply span3",TAG("div","overlay-fluid",a.message),a.id)}function renderAward(a){var b=SUBJECT_MAP[a.subject];return thumbitem(BADGE(a.badge),"bg-white action-award span3",TAG("div","text-center item-title",badgeTranslate(a.badge))+(b?TAG("div","text-center text-muted",TAG("small",b)):"")+TAG("div","text-center fg-lightBlue item-title-secondary",dateConverter(a.date)),a.badge.split("_")[0]+a.subject)}function renderUserListView(a){var c=processContent(a.desc);var b=renderAvatar(a)+renderUserRaw(a,"%%% ("+a.username+")")+"&nbsp;"+TAG("span",COLOR_CLASS.SCHOOL,a.school+"/"+a.class_name)+"&nbsp;"+TAG("span","text-muted place-right",TAG("span",a.is_followed_by?COLOR_CLASS.LABEL_ACTIVE:"",ICON("pop-out")+a.following_count)+"‧"+TAG("span",a.is_following?COLOR_CLASS.LABEL_ACTIVE:"",ICON("pop-in")+a.followers_count)+"<br/>"+getRelationWithUser(a))+(a._date?"<br/>"+TAG("span","list-datetime",(dateConverter(a._date))+(SUBJECT_MAP[a._subject]?", "+SUBJECT_MAP[a._subject]:"")):"")+TAG("pre","list-subtitle",c);return listitem(b)}function renderButton(b,a){if(b.id=="00"&&!b.related){return""}if(!a){return""}if(b.flagged){a=ICON("locked-2")+" "+a}var c=b.related||b.id;if(b.category=="!vote"&&b._related.category=="answer"){c=b._related.related||null}if(!c){return""}return renderButtonRaw(a,"large primary place-right action-reply",c)}function renderButtonRaw(c,b,a,d){if(!a){return""}return TAG(d||"button",b,"data-id='"+a+"'",c)}function renderScore(a){return renderScoreVoteRaw(a.score,"info")}function renderVote(b){var a=b.score>0?"success":"alert";return renderScoreVoteRaw(b.score,a)}function renderScoreVoteRaw(b,a){a="label place-right"+(b?" zoomin "+a:"");return TAG("span",a,b)}function renderAbstract(b){var a=RENDER_ENG.category1[b.category].base;var c=/#(.+)#/;a=a.replace(c,TAG("span","text-info"," $1 "));if(a.indexOf("&&&")>=0){a=a.replace("&&&",renderPopLabel(b))}if(a.indexOf("%%%")<0){return a}return a.replace("%%%",TAG("strong",renderInlineName(b,true)))}function renderBadgeImage(b){if(HASH.levelName[b.badge]){return""}var a={};a.badge=b.badge;a.subject=b.subjects[0].id;a.date=b.date;return TAG("span","list-clearfix",TAGb(a))}function renderSSTitle(d){var e=[];for(var b=0;b<d.voters.length;++b){e.push(d.voters[b].name)}var c=dateConverter(d.date);var a=renderSubject(d,5);c+=(needSubject(d.category)?TAG("span","text-muted"," 科目："+a):"")+(e.length?"<br/>"+TAG("span","text-muted place-right voterlightbox","data-id='"+d.id+"'","誰評分："+e.join(", ")):"");return c}function compactMsg(d){var c=function(){return TAG("strong",renderInlineName(d))};var a=function(e){return TAG("span",e,renderPopLabel(d))};if(d.category=="!follow"){return"正在"+TAG("span",COLOR_CLASS.FOLLOW,"關注")+"你。"}else{if(d.category=="!badge"){if(isLevel(d.badge)){return"現在是 "+TAG("strong",SUBJECT_MAP[d.subjects[0].id])+"科 的 "+TAG("strong",badgeTranslate(d.badge))+" "+TAG("span",COLOR_CLASS.BADGE,"等級")+"！"}else{var b=SUBJECT_MAP[d.subjects[0].id];if(d.subjects[0].id==10001){b=false}return"榮獲了 "+(b?TAG("strong",b)+"科 的 ":"")+TAG("strong",badgeTranslate(d.badge))+" "+TAG("span",COLOR_CLASS.BADGE,"獎章")+"！"}}else{if(d.category=="!emotion"){if(d.message==0){return"清除了他對"+c()+"的 "+a(COLOR_CLASS.EMOTION)+" 的"+TAG("strong",COLOR_CLASS.EMOTION,"表情")+"。"}return"給了"+TAG("strong",c())+"的 "+a(COLOR_CLASS.EMOTION)+" 一個 "+TAG("strong",COLOR_CLASS.EMOTION,HASH.mood[d.message])+" 表情！"}else{if(d.category=="!vote"){if(d.message=="clear"){return"清除了他對"+TAG("strong",c())+"的 "+a(COLOR_CLASS.VOTE)+" 的"+TAG("strong",COLOR_CLASS.VOTE,"評價")+"。"}return"給了"+TAG("strong",c())+"的"+a(COLOR_CLASS.VOTE)+"一個 "+TAG("strong",COLOR_CLASS.VOTE,d.message=="up"?(ICON("thumbs-up")+" 讚"):(ICON("thumbs-down")+" 遜"))+"！"}else{return"<Unknown Information>"}}}}}function renderInlineName(g,e){var f=g._related;var d=g._related_user;if(!d){console.log("[renderInlineName] The post is marked as rel, but no reluser found.");return UNKNOWN()}var c=d.name;if(!c){return UNKNOWN()}if(f){d.name=" "+d.name+" ";var a=false;if(d.id==g.from){c="他自己"}else{if(isMyself(d)){c="你"}else{var b="";if(e){b=renderAvatarRaw(g._related_user,"inline-small userlightbox on-right-more")+" "}return b+renderUserRaw(d)}}}return c}function renderPopLabel(f){var c=f._related;if(!c){return UNKNOWN()}var d=RENDER_ENG.category1[c.category];var g=f._related?(RELATED_CATEGORY[c.category]||d.label):UNKNOWN();var b=(c.image?TAGi(c.image,80)+"<br/>":"");var a=normalize(truncateText(c.message,150)).replaceAll("\n",TEXT_RETURN_ALT);var e=b+a.replaceAll("'",'"');return frag="<span data-toggle='popover' data-placement='auto left' data-title='"+RENDER_ENG.category1[c.category].label+RENDER_ENG.category1[c.category].scoreFN(c)+"' data-content='"+e+"' class='pop-over'>"+g+"</span>"}USE_MOBILE_RULE=false;main();function main(){Shadowbox.init({skipSetup:true,viewportPadding:24});checkUseMobileRule();$(init)}function init(){try{if(FREEZE){return}var b=new Date();$("a[href='#']").attr("href","javascript:void(0)");switchNavByType("user");overrideAJAX();cookieObject.init();setupListeners();navBtnListeners();initOverlayButtons();translateMagnificPopup();$.magnificPopup.defaults.fixedBgPos=true;fillInConstants();loadExternalData();console.log("[Startup] "+(new Date()-b)+"ms, start logging in.");initLogin()}catch(a){alert("Error occured while initializing!\n"+a.toString()+"\nPlease report the fatal error.")}}function fillInConstants(){$("#btn-user-name").html("Logging in...");$("#dp-mac").html(cookieObject.load("mac"));$(".fill-version").html(VERSION_MAJOR+VERSION_MINOR+VERSION_COUNT);$(".fill-version-count").html(VERSION_COUNT);$(".fill-last-modify").html(LAST_MODIFY);$(".fill-random-tip").html(randomTip[Math.floor(Math.random()*randomTip.length)].replaceAll("|","<br/>"))}function setupListeners(){var a=new Date();checkMAC();$(".login-dialer button").addClass("large").css("width","33%").click(fillMAC);$("#accountBtn").click(showUserLightbox);$(".action-account").click(showUserLightbox);$("#logoutBtn").click(function(){navClick();confirmClearMAC()});$(".action-refresh").click(refreshMain);$("#nav-following").click(showFollowingPopup);$("#nav-follower").click(showFollowerPopup);$("#login-input-mac").keyup(checkMAC);$("#editInfoBtn").click(modalMyInfo);$("#pinRefreshBtn").click(checkAllPinPosts);$("#pinAllReadBtn").click(clearAllPinUnread);$(document).on("click",".userlightbox",showUserLightbox).on("click",".moodlightbox",showMoodLightbox).on("click",".voterlightbox",showVoterLightbox).on("click",".action-reply",modalShowReply).on("click",".action-award",modalShowAward).on("click",".action-badgewinner",modalShowBadgeWinners).on("click",".action-vote-up",voteUpClick).on("click",".action-vote-down",voteDownClick).on("click",".action-reveal-rm",readRMPostAndRender).on("shown.bs.popover",'*[data-toggle="popover"]',addLightbox);console.log("[init/SetupListeners] "+(new Date()-a)+"ms")}function loadExternalData(){var a=$("[data-load]");var b=0;a.each(function(){var c=$(this);c.load(c.data("load"),function(){b++;console.log("[~DataLoad] loaded "+c.data("load")+", "+b+" / "+a.length);if(a.length==b){reinit();initOnce();initHashRoutes()}})})}var initOnce=function(){var e=new Date();$("#btn-loadmore").click(loadMore);$("#btn-loadmore-reply").click(loadMoreReply);$("#btn-loadmore-users").click(loadMoreUsers);$("#btn-loadmore-announcement").click(loadMoreAnnouncement);$(".action-refresh-reply").click(refreshReply);$(".action-refresh-by-score").click(sortReplyByScore);$(".action-refresh-reverse").click(sortReplyReverse);$("#action-toggle-pin-list").click(togglePinList);$(".action-pin-post").click(togglePinCurrentPost);$(".action-dismiss").click(modalHide);$("#postshare-category").change(postshareCategoryChange);for(var c=0;c<SUBJECT_CATEGORY_NAME.length;++c){var d="",a=1;$("#postshare-subject-category").append(TAG("option","","value='"+(c+1)+"'",SUBJECT_CATEGORY_NAME[c]));$("#postshare-subject-container").append(TAG("select","postshare-subject","multiple='multiple'",""));while(SUBJECT_MAP[String(c+1)+numFill(a,4)]){var b=String(c+1)+numFill(a,4);d+=TAG("option","","value='"+b+"'",SUBJECT_MAP[b]);a++}$(".postshare-subject").eq(c).html(d)}$(".postshare-subject").change(changeSubjectSelection);$("#postshare-subject-category").change(postshareSubjectCategoryChange);postshareSubjectCategoryChange();postshareCategoryChange();$("#users-search").submit(searchUserSubmit);$("#reply-ok .panel-content").slideToggle();$("#_loadingState")[0].outerHTML="";switchVisible("#header,#root",true);initOnce=function(){};console.log("[initOnce] ended "+(new Date()-e)+" ms")};function initOverlayButtons(){$("#btn-bringtop").click(function(){$("html,body").animate({scrollTop:0},400)});$(window).scroll(function(){if($(this).scrollTop()>800){$("#btn-bringtop").fadeIn("fast")}else{$("#btn-bringtop").stop().fadeOut("fast")}});$("#btn-bringtop").fadeOut("fast")}function checkUseMobileRule(){if(typeof localStorage!="undefined"){USE_MOBILE_RULE=!!localStorage.getItem("use-mobile")||false}if(USE_MOBILE_RULE){console.log("[checkUseMobileRule] Rule applied.")}}var myProfile={};var SKIP_SPLASH=0;var GIVE_UP_LOADING=0;var FREEZE=0;function initLogin(){if(location.hash!=""&&location.hash!="#!"){SKIP_SPLASH=true}if(!SKIP_SPLASH){modal("#popup-welcome",true,true);splashNeedClose=true}$("#welcome-mac").html(cookieObject.load("mac"));if(!cookieObject.load("mac")){modal("#popup-login",true,true);return}if(typeof localStorage!="undefined"){var a}if(a=localStorage.getItem("identity")){myProfile=JSON.parse(a);try{if(!GIVE_UP_LOADING){viewLoad({})}console.log("[doLogin] Cached identity discovered. Use it.")}catch(b){localStorage.removeItem("identity");console.log("[doLogin] Corrupted user data. Cleared.")}}readProfile();getPinList();if(!URL_PROXY){$("#welcome-hst").addClass("error").html("[N/A]")}else{loadFromProxy("did_login",{did:cookieObject.load("mac")},function(c){$("#welcome-hst").addClass("success").html("[200 OK]")})}}function relogin(){if(!checkMAC()){alert("MAC無效，無法登入。");return}$.cookie("mac",$("#login-mac").html(),{expires:365});location.reload()}function doLogin(b){var a=!(myProfile=={});myProfile=b.profile;currentProfile=myProfile;if(!a){return}$("#welcome-mac").addClass("success");$("#welcome-msg").html("Hello, "+myProfile.name+" ("+myProfile.username+")");$("#welcome-img").attr("src",imageLM(myProfile.image));$("#welcome-school").html(myProfile.school);$("#accountBtn").data("id",myProfile.username);$(".action-account").data("id",myProfile.username);$(".fill-username").html(myProfile.name);$("#btn-user-img").attr("src",imageLM(myProfile.image));if(typeof localStorage!="undefined"){if(!localStorage.getItem("identity")){if(!GIVE_UP_LOADING){viewLoad({})}}localStorage.setItem("identity",JSON.stringify(b.profile))}$("#welcome-hint").css("opacity",1);if(!SKIP_SPLASH){setTimeout(function(){if(splashNeedClose){modalHide()}},SPLASH_OFF_DURATION)}}function doLoginFailure(b){$("#welcome-msg").html("Login Failed!");$("#welcome-mac").addClass("error");var a=confirm("登入失敗...\n要清除掉MAC然後重新嘗試嗎？");if(a){clearClientData();location.reload()}}function checkMAC(){var a=macConverter($("#login-input-mac").val());$("#login-mac").html(a.mac);if(a.valid){$("#login-mac").removeClass("text-muted")}else{$("#login-mac").append(" [無效]");$("#login-mac").addClass("text-muted")}return a.valid}function confirmClearMAC(){if(cookieObject.load("mac")){ans=confirm("即將從 LMClient 登出，確定？");if(ans){clearClientData();alert("登出成功。\n謝謝您的使用，歡迎再度光臨。");location.reload()}else{return}}}function fillMAC(){if($(this).hasClass("void")){return}if($(this).hasClass("backspace")){var a=$("#login-input-mac")[0].value;$("#login-input-mac")[0].value=a.substr(0,a.length-1)}else{if(!checkMAC()){$("#login-input-mac")[0].value+=$(this).html()}}checkMAC()}function clearClientData(){var b=$.cookie();for(var a in b){$.removeCookie(a)}localStorage.removeItem("identity")}function modalShowReply(b){var a=$(this);var c=a.data("id");if(a[0].nodeName=="BUTTON"){$(".marked").removeClass("marked");a.parent().parent().addClass("marked")}location.hash="#!/post/"+c+""}function addLightbox(){Shadowbox.setup("a.imglightbox");$('*[data-toggle="popover"]').popover({container:"#root",html:true,trigger:"hover",delay:{show:200,hide:1200}})}function voteUpClick(a){if($(this).hasClass("inverse")){postVote("up",$(this).data("id"))}else{postVote("clear",$(this).data("id"))}}function voteDownClick(a){if($(this).hasClass("inverse")){postVote("down",$(this).data("id"))}else{postVote("clear",$(this).data("id"))}}function readRMPostAndRender(){var b=$(this);if(!b.data("rm")){return}var a=confirm("觀看被RM的貼文是一項禁忌的功能，於 2014/2/12 推出，請低調使用。\n還是要繼續嗎？");if(!a){return}b.html(ICON("busy")+" 載入RM貼文中...");loadFromProxy("RMpost",{id:b.data("rm"),mac:cookieObject.load("mac")},function(d){if(!d){return}var c=modifyObj(d.list[0],d);c.flagged=false;c._flagged=true;var e=!b.parents(".list").hasClass("autoheight");b.parents(".list").replaceWith(renderPostListView(c,e));addLightbox()})}function loadMore(){mainLoader.loadMore()}function loadMoreReply(){setShow("#reply-content-loading","",false);getRelated({id:replyObject.id,before:replyObject._oldest})}function loadMoreAnnouncement(){setShow("#announcement-loading","",false);listAnnouncement({before:lastestAnnouncementID,count:10},false)}function refreshMain(){viewLoad(deleteProp(mainLoader.lastReq,"before"),true)}function viewRecognize(e,a){e=e||{};var d="",f="",b="";if(e.user){if(e.user==myProfile.uid||e.user==myProfile.username){d="自己";f=COUNT.HOMEPAGE}else{d=currentProfile.name+" ";f=COUNT.NOTIFICATION}d+="的"+getCategory(e.category);b="user"}else{if(e.category&&e.category.indexOf("_")!=0){d=getCategory(e.category);b=e.category;if(e.sort=="score"){f=COUNT.HOT}else{if(e.sort=="date"){f=COUNT.NOTIFICATION}else{f=COUNT.NOTIFICATION}}}else{if(e.sort){d="[不分類]";b="";f=COUNT.NOTIFICATION}else{d="首頁";b="homepage";f=COUNT.NOTIFICATION}}}if(e.category=="scrapbook"&&mainLoader.parse==parsePostThumbView){f=COUNT.ALBUM}if($("#pin-list").css("display")!="none"){togglePinList()}switchNavByType(b);navUpdate(e);setLocation(d);e.count=f}function viewLoad(b,a,c){mainLoader.clearBefore=a;mainLoader.parse=c||parsePostListView;mainLoader.load("list",b)}function viewLoadMerge(b,a,c){viewLoad($.extend(mainLoader.lastReq,b),a,c)}function getCategory(b){var a;if(b){if(a=RENDER_ENG.category1[b]){return a.label}else{if(a=RENDER_ENG.category2[b]){return a.label}}}return"大聲公"}function setLocation(a){$("#nav-location").html(a)}function deleteProp(a,b){a[b]=null;return a}function replyBringToTop(){var b=$(".mfp-wrap");if(b.css("position")=="absolute"){var a=parseInt(b.css("top"));$("html,body").scrollTop(a)}else{b.animate({scrollTop:0},FX_BRING_TOP_DURATION)}}function orientateLightbox(a,b){var d=$(window);var c=d.width();if(c<=640){return{w:a*1.25,h:a}}return{w:a,h:b}}function showUserLightbox(a){lightbox({content:$(".ext-userview")[0].outerHTML,player:"html",options:{onFinish:function(b){addToUserLightbox()}},height:360,width:600});userProfile=null;readUserProfile({user:$(this).data("id")})}function showMoodLightbox(a){var b=orientateLightbox(900,450);lightbox({content:$(".ext-moodview")[0].outerHTML,player:"html",options:{onFinish:function(c){assert(detailedMood.length==5,"showMoodLightbox","Mood is not loaded yet!");addToMoodLightbox();$(".ext-moodview").css("opacity",1)}},height:b.h,width:b.w})}function showVoterLightbox(){voter=[];var a=orientateLightbox(900,450);lightbox({content:$(".ext-voterview")[0].outerHTML,player:"html",options:{onFinish:function(b){addToVoterLightbox()}},height:a.h,width:a.w});getVoter({id:$(this).data("id"),count:COUNT.VOTER})}function addToUserLightbox(){if(userProfile){var b=$("#sb-player .ext-userview");if(!b[0]){console.log("[addToUserLightbox] type=objmiss");return}var d=b.find(".userview-block");var c=b.find(".userview-tool");if(!userProfile._rendered){$("#sb-player .ext-userview .userview-cover").attr("src",imageLM(userProfile.cover,"X"));d.click(function(){alert(userProfile.desc?"自介：\n--------\n"+userProfile.desc+"\n--------\n":"此人沒有自介！")});b.find(".userview-image").attr("src",imageLM(userProfile.image));d.find(".title").html(userProfile.name+" ("+userProfile.username+")");d.find(".subtitle").html(userProfile.school+" "+(userProfile.class_name=="TH"?"老師":userProfile.class_name));b.css("opacity",1);c.find(".userview-go").click(function(){currentProfile=userProfile;viewLoad({user:userProfile.username},true);modalHide();Shadowbox.close()})}var e=getRelationWithUser(userProfile);e&&(e+="‧");b.find(".userview-info").html(e+("已關注 %%% 人‧被 @@@ 人關注".replace("%%%",userProfile.following_count).replace("@@@",userProfile.followers_count)));switchVisible(d.find(".following"),userProfile.is_followed_by);var a=c.find(".userview-following");a.data("id",userProfile.username);a.off().removeClass("danger info");if(isMyself(userProfile)){a.attr("disabled","disabled").html(ICON("home")+" 你自己")}else{if(userProfile.is_following){a.addClass("danger").html(ICON("link-2")+" 取消關注").click(function(){postIfFollow($(this).data("id"),false)})}else{a.addClass("info").html(ICON("link")+" 關注").click(function(){postIfFollow($(this).data("id"),true)})}}userProfile._rendered=true}console.log("[addToUserLightbox] type="+(userProfile?"ok":"pending"))}var detailedMood=[];function addToMoodLightbox(){assert(detailedMood.length==5,"addToMoodLightbox","Mood is not loaded yet!");var b=$("#sb-player .ext-moodview .list-content").find("div");for(var e=0;e<5;++e){var a=detailedMood[e],f=[];for(var d=0;d<a.length;d++){var c=renderAvatarRaw(a[d],"inline shadow userlightbox");var h=renderUserRaw(a[d]);var g=TAG("small","["+dateConverter(a[d]._mood_date)+"]");f.push(TAG("div","","style='display:inline-block'",c+h+"<br/>"+g))}b.eq(e).html(f.length?f.join(",&nbsp;"):TAG("span","text-muted","Nobody..."))}}var voter=[];function addToVoterLightbox(){var b=$("#sb-player .ext-voterview .list-content").find("div");if(!b[0]){console.log("[addToVoterLightbox] type=objmiss");return}if(!voter.length){console.log("[addToVoterLightbox] type=pending");return}for(var e=0;e<2;++e){var a=voter[e],f=[];for(var d=0;d<a.length;d++){var c=renderAvatarRaw(a[d],"inline shadow userlightbox");var h=renderUserRaw(a[d]);var g=TAG("small","["+dateConverter(a[d]._vote_date)+"]");f.push(TAG("div","","style='display:inline-block'",c+h+"<br/>"+g))}b.eq(e).html(f.length?f.join(",&nbsp;"):TAG("span","text-muted","Nobody..."))}$(".ext-voterview").css("opacity",1);console.log("[addToVoterLightbox] type=ok")}function openPostShareForm(){setShow("#postshare-ok","#postshare-processing",false);modal("#popup-postshare",false,true)}function openNewsForm(){modal("#popup-news",false,true)}function showFollowerPopup(){showUsersPopup((isMyself(currentProfile)?"":currentProfile.name+" 的 ")+"粉絲團 ("+currentProfile.followers_count+")");switchVisible("#users-search",false);searchFollower(null,true);usersMoreFN=searchFollower}function showFollowingPopup(){showUsersPopup((isMyself(currentProfile)?"":currentProfile.name+" 的 ")+"我關注 ("+currentProfile.following_count+")");switchVisible("#users-search",false);searchFollowing(null,true);usersMoreFN=searchFollowing}function showUsersPopup(a){modal("#popup-users");clrUsersPopup();setShow("#users-loading","#users-ok",false);$("#popup-users").find("h3").html(a);lastestUsersReq=""}function modalShowAwardRaw(k){showUsersPopup("獎牌");clrUsersPopup();switchVisible("#users-search",false);switchVisible("#users-award",true);setShow("#users-loading","#users-ok",true);var e=k[k.length-1].badge;var d=badgeSearch(e);var a=SUBJECT_MAP[k[0].subject];if(a){a="<br/>"+a}else{a=""}$("#users-award-img").html(TAGb2(e));addLightbox();$("#users-award-badgename").html(d[0][0]+d[1]+TAG("small",a));$("#users-award-desc1").html(d[0][1][0].replaceAll("|","<br/>"));$("#users-award-desc2").html(d[0][1][1].replaceAll("|","<br/>"));$(".users-award").removeClass("info");var h=new Array(3);for(var g=0;g<k.length;++g){var c=badgeOrder(k[g].badge);h[c]=k[g]}var j=0;for(var g=0;g<3;++g){var b=$(".users-award").eq(g).children("td");b.eq(1).html(d[0][2][g]);if(h[g]){var f=h[g].badge;j=g;b.eq(2).html(dateConverter(h[g].date));b.eq(3).html(renderButtonRaw("觀看","success action-badgewinner",f))}else{b.eq(2).html("...");b.eq(3).html("...")}}$(".users-award").eq(j).addClass("info");searchBadgeWinners({badge:e},true)}function modalShowAward(){if($(this).data("id")){modalShowAwardRaw(badgeObj[$(this).data("id")])}else{var a=$(this).data("badge");var c=$(this).data("subject");var b=$(this).data("date");var d=[{badge:a,subject:c,date:b}];modalShowAwardRaw(d)}}function modalShowBadgeWinners(){var a=$(this).data("id");var b=badgeSearch(a);$("#users-award-img").html(TAGb2(a));addLightbox();$("#users-award-badgename").html(b[0][0]+b[1]);searchBadgeWinners({badge:a},true)}function postshareSubjectCategoryChange(){var c=(this==window)?"0":$(this).val()-1;var b=(c<0);for(var a=0;a<SUBJECT_CATEGORY_NAME.length;++a){switchVisible(".postshare-subject:eq("+a+")",b||a==c);$(".postshare-subject").eq(a).attr("size",b?1:12)}}function postshareCategoryChange(){var a=(this==window)?"share":$(this).val();switchVisible(".postshare-o1",a=="question");switchVisible(".postshare-o2",a!="scrapbook");switchVisible(".postshare-o3",a=="scrapbook");switchVisible(".postshare-o4",a!="watch");switchVisible(".postshare-o5",a=="watch");switchVisible(".postshare-o3.postshare-o5",a=="scrapbook"||a=="watch")}function changeSubjectSelection(){$("#postshare-subject-count").html($(".postshare-subject option:selected").length)}function selectAllSubjects(b){var a=$(".postshare-subject option:not(:selected)").length!=0;$(".postshare-subject option").prop("selected",a);changeSubjectSelection();b.preventDefault()}var myInfoCount=0;function modalMyInfo(){if(!myProfile){throw new Error("myProfile is not ready to be used!")}setShow("#myinfo-processing","#myinfo-ok",true);modal("#popup-myinfo",false,true);$("#myinfo-name").val(myProfile.name);$("#myinfo-username").val(myProfile.username);$("#myinfo-email").val(myProfile.email);$("#myinfo-web").val(myProfile.web);$("#myinfo-location").val(myProfile.location);$("#myinfo-build_number").val(myProfile.build_number);$("#myinfo-desc").val(myProfile.desc)}function postMyInfoForm(){setShow("#myinfo-processing","#myinfo-ok",false);var a=addFormDataIfChanged(["name","username","email","web","build_number","location","desc"],"#myinfo-");if(a){myInfoCount++;postProxy("updateProfile",a,myInfoSuccess)}postMyInfoImage($("#myinfo-file-image")[0],"image");postMyInfoImage($("#myinfo-file-cover")[0],"cover");if(!a&&myInfoCount==0){checkMyInfo(true)}}function postMyInfoImage(b,a){if(b.files&&b.files[0]){myInfoCount++;var c=new FormData();c.append("device",cookieObject.load("mac"));c.append(a,b.files[0]);postProxy("uploadProfileImage",c,myInfoSuccess)}}function myInfoSuccess(a){myInfoCount--;if(myInfoCount){notify.info("成功上傳！(剩餘"+myInfoCount+"個上傳作業)")}else{checkMyInfo()}}function checkMyInfo(a){if(myInfoCount!=0){return}readProfile();notify.complete({message:a?"個人資料並未更動。":"成功修改個人資料！"});modalHide()}function addFormDataIfChanged(a,e){var f=new FormData(),c=false;f.append("device",cookieObject.load("mac"));for(var b=0;b<a.length;++b){var g=myProfile[a[b]];var d=$(e+a[b]).val();if(g!=d){console.log("[addFormDataIfChanged] changed id="+a[b]);f.append(a[b],d);c=true}}return c?f:null}function navBtnListeners(){$("#allActivity").click(function(){navClick();viewLoad({sort:"date"},true)});$("#myActivity").click(function(){navClick();viewLoad({},true);currentProfile=myProfile});$("#myActivity2").click(function(){navClick();viewLoad({user:myProfile.username,sort:"date"},true);currentProfile=myProfile});$("#shh5").click(function(){navClick();viewLoad({category:"!badge",sort:"date"},true)});$("#shh3").click(function(){navClick();listAnnouncement({count:COUNT.ANNOUNCEMENT},true);modal("#popup-announcement");setShow("#announcement-loading","",false)});$("#action-search").click(function(){navClick();showUsersPopup("搜尋使用者");setShow("#users-loading","#users-ok",true);switchVisible("#users-search",true);switchVisible("#users-award",false)});$("#nav-myfollow").click(function(){mainLoader.lastReq=deleteProp(deleteProp(mainLoader.lastReq,"user"),"sort");viewLoad(mainLoader.lastReq,true)});$("#nav-new").click(function(){mainLoader.lastReq=deleteProp(mainLoader.lastReq,"user");viewLoadMerge({sort:"date",before:null},true)});$("#nav-hot").click(function(){mainLoader.lastReq=deleteProp(mainLoader.lastReq,"user");viewLoadMerge({sort:"score",before:null},true)});$("#nav-unanswered").click(function(){if(mainLoader.lastReq.unanswered){viewLoad(deleteProp(mainLoader.lastReq,"unanswered"),true)}else{viewLoadMerge({unanswered:true,sort:"date",before:null},true)}});$("#nav-album").click(function(){var a={category:"scrapbook"};a.user=mainLoader.lastReq.user||myProfile.username;viewLoadMerge(a,true,parsePostThumbView)});$("#nav-award").click(function(){if(mainLoader.lastReq.category=="__badge"){viewLoad(deleteProp(mainLoader.lastReq,"category"),true)}else{viewLoadMerge({category:"__badge"},true)}});$(".action-sel").click(function(){var a=$(this).data("category");if(a!="all"){viewLoadMerge({category:a},true)}else{mainLoader.lastReq=deleteProp(mainLoader.lastReq,"category");viewLoad(mainLoader.lastReq,true)}});$(".action-sel-em").click(function(){var b=$(this).data();var a=b.sort||null;viewLoad({category:b.category,sort:a,before:null},true)})}function switchNavByType(a){switchVisible("nav .questionmenu",a=="question");switchVisible("nav .usermenu",a=="user"||a=="homepage"||a=="__badge");switchVisible("nav .nohomemenu",a=="user");switchVisible("nav .categorymenu",a=="question"||a=="share"||a=="scrapbook"||a=="comment"||a=="answer"||a=="watch"||a=="practice"||a=="annotation"||a=="course");switchVisible("nav .hotmenu",a=="question"||a=="share"||a=="scrapbook"||a=="answer")}function navUpdate(b){$("nav").find(".categorymenu,.questionmenu,.usermenu,.hotmenu").find("a").removeClass("text-muted").removeClass("text-success");var a=[];if(b.unanswered){a.push("#nav-unanswered")}if(b.category=="scrapbook"){a.push("#nav-album")}if(b.category=="__badge"){a.push("#nav-award")}switchVisible("#nav-hot",!b.unanswered);switchVisible("#nav-myfollow,#nav-myself",b.category);if(b.user==myProfile.uid||b.user==myProfile.username){a.push("#nav-myself")}else{if(b.sort=="score"){a.push("#nav-hot")}else{if(b.sort=="date"){a.push("#nav-new")}else{a.push("#nav-myfollow")}}}$(a.join(",")).removeClass("text-muted").addClass("text-success")}notify={connectFailure:function(a,b){$.Notify({caption:ICON("cancel")+" 連線失敗!",content:a+"<br/>請手動按鈕重新整理對應內容. ",style:{background:"rgb(255,45,25)",color:"white"},timeout:b||NOTIFY_TIME.MEDIUM})},abort:function(a,b){$.Notify({caption:ICON("cycle")+" 重新連線. ",content:a,style:{background:"white",color:"rgb(51,51,51)"},timeout:b||NOTIFY_TIME.SHORT})},verbose:function(a,b){$.Notify({caption:ICON("console")+" 除錯.",content:a,style:{background:"white",color:"rgb(51,51,51)"},timeout:b||NOTIFY_TIME.MEDIUM})},warning:function(a,b){$.Notify({caption:ICON("console")+" 注意!",content:a,style:{background:"rgb(255,220,0)",color:"rgb(51,51,51)"},timeout:b||NOTIFY_TIME.LONG})},error:function(a,b){$.Notify({caption:ICON("cancel")+" 錯誤!",content:a,style:{background:"rgb(170,0,0)",color:"white"},timeout:b||NOTIFY_TIME.MEDIUM})},complete:function(a,b){$.Notify({caption:ICON("checkmark")+" 完成!",content:a.message+"<br/>"+notifyStatusRenderer(a.status),style:{background:"rgb(0,138,0)",color:"white"},timeout:b||NOTIFY_TIME.MEDIUM})},info:function(a,b){$.Notify({caption:ICON("star-3")+" 成功!",content:a,style:{background:"rgb(27,161,226)",color:"white"},timeout:b||NOTIFY_TIME.MEDIUM})},update:function(a,b){if(a.once){$.Notify({caption:ICON("flag-2")+" 共有 "+a.count+" 個追蹤貼文更新了! ",content:"在主畫面點開追蹤列表查看! ",style:{background:"rgb(27,161,226)",color:"white"},timeout:b||NOTIFY_TIME.LONG});return}$.Notify({caption:ICON("flag-2")+" 追蹤貼文有 "+a.count+" 個更新! ",content:a.message+"<br/>點擊此處查看! "+TAG("span","","data-id='"+a.id+"'",""),style:{background:"rgb(27,161,226)",color:"white"},timeout:b||NOTIFY_TIME.LONG});$(".notify-container span[data-id='"+a.id+"']").parent().parent().data("id",a.id).click(modalShowReply)}};function notifyStatusRenderer(a){if(!a||!a.http_code){return""}return"花費時間："+roundTo(a.total_time,2)+" sec<br/>大小 (↑/↓)："+roundTo(a.size_upload/1000,3)+" / "+roundTo(a.size_download/1000,3)+" KB<br/>速度 (↑/↓)："+roundTo(a.speed_upload/1000,3)+" / "+roundTo(a.speed_download/1000,3)+" KB/sec"}var pinList;var pinCount,pinFinish,pinDeferred,pinIdle=true;var pinObject;function initPinList(c){c=c?c.data:{};pinIdle=false;pinList={};pinObject={};pinCount=0;pinDeferred=0;for(var a in c){var b=c[a];if(b){addPinPost(a,b.count,b.unread);readPinPostContent(a)}}pinFinish=0;updatePinCount();console.log("[getPinList] Success",c);setInterval(checkAllPinPosts,30000)}function readPinPostContent(a){loadFromLM("read",{id:a},initPinPost,null,true)}function checkSinglePinPost(a){loadFromLM("read",{id:a},updateSinglePinPost,null,true)}function initPinPost(f){var e=modifyObj(f.list[0],f);var g=e.id;var b=pinList[g].count;var d=e.ref_count;var c=d-b;var a=$("#pin-list .list[data-id='"+g+"']");a.removeClass("undone").html(renderPinPostInner(e));console.log("initPinPost",b,"->",d);if(c){assert(c>0,"updateSinglePinPost","Negative difference.");pinList[g].unread+=c;pinList[g].count=d;loadFromLM("list",{related:g,sort:"date",count:Math.min(pinList[g].unread,COUNT.PIN)},updatePinPostReply,null,true);pinDeferred++}else{pinFinish++}if(pinList[g].unread){switchPinMark(g,true).find(".label.fill-count").html("+"+pinList[g].unread)}else{switchPinMark(g,false).find(".label.fill-count").html(0)}updatePinCount()}function updatePinPostReply(f){pinFinish++;updatePinCount();var c=f.list;if(!f.list[0]){return}var g=f.list[0].related;var b=$("#pin-list .list[data-id='"+g+"']");var e="";for(var a in c){var d=modifyObj(c[a],f);e+=TAG("span",renderPinPostReply(d))+"&nbsp;&nbsp;&nbsp;"}if(b.find(".list-appendix").length){b.find(".list-appendix").html(e)}else{b.append(TAG("div","list-appendix text-muted",e))}}function checkAllPinPosts(){if(!pinIdle){return}pinFinish=0;pinIdle=false;for(var a in pinList){checkSinglePinPost(a)}}function updateSinglePinPost(f){var e=modifyObj(f.list[0],f);var g=e.id;var b=pinList[g].count;var d=e.ref_count;var c=d-b;var a=$("#pin-list .list[data-id='"+g+"']");if(c){assert(c>0,"updateSinglePinPost","Negative difference.");if(pinList[g].unread!=c&&pinIdle){notify.update({count:c,id:g,message:truncateText(e.message.replaceAll("\n"," "),20)})}pinList[g].count=d;pinList[g].unread+=c;if(pinIdle){postSavePinList()}else{pinDeferred++}loadFromLM("list",{related:g,sort:"date",count:Math.min(pinList[g].unread,COUNT.PIN)},updatePinPostReply,null,true)}else{pinFinish++}if(pinList[g].unread){switchPinMark(g,true).find(".label.fill-count").html("+"+pinList[g].unread)}else{switchPinMark(g,false).find(".label.fill-count").html(0)}updatePinCount()}function addPinPost(c,b,a){pinList[c]={unread:a||0,count:b||0};pinObject[c]={};$("#pin-list").append(TAG("div","list post autoheight undone","tabindex='0' data-id='"+c+"'",TAG("div","list-content","載入 "+c+" 中...")));pinCount++;updatePinCount()}function removePinPost(a){pinList[a]=undefined;pinObject[a]=undefined;$("#pin-list .list[data-id='"+a+"']").remove();pinCount--;pinFinish--;updatePinCount()}function clearUnread(a){switchPinMark(a,false).find(".label.fill-count").html(0);pinList[a].unread=0}function clearAllPinUnread(){for(var a in pinList){clearUnread(a)}}function updatePinCount(){var b=pinFinish,a=pinCount;var c=$(".fill-pin-count");if(b==a){c.html(a);c.parent().removeClass("text-muted").addClass("text-info");pinReady=true;pinIdle=true;console.log("[updatePinCount] pinReady and pinIdle");if(pinDeferred){notify.update({once:true,count:pinDeferred});postSavePinList();pinDeferred=0}}else{c.html(TAG("div","progress-bar","data-role='progress-bar' data-value='0'"));c.find("div.progress-bar").data("value",b/a*100);c.parent().removeClass("text-info").addClass("text-muted")}}function togglePinCurrentPost(){var a=replyObject.id;if(!pinList){notify.error("追蹤列表尚未就緒, 請稍後再試.");return}if(!pinList[a]){addPinPost(a,replyObject.ref_count);readPinPostContent(a);switchPinMark(a,false).find(".label.fill-count").html(0);notify.info("追蹤現在是ON",1000)}else{removePinPost(a);notify.info("追蹤現在是OFF",1000)}postSavePinList();checkPinPostButton()}function checkPinPostButton(){var a=pinList[replyObject.id];$(".action-pin-post").html(a?ICON("star-3")+" 追蹤ON":ICON("star")+" 追蹤OFF");switchClass(".action-pin-post","primary",a)}function togglePinList(){var a=$("#pin-list");if(a.css("display")=="none"){a.fadeIn({duration:FX_VIEW_DURATION,queue:false}).css("display","none").slideDown(FX_VIEW_DURATION)}else{a.css("opacity",1).fadeOut({duration:FX_VIEW_DURATION,queue:false}).slideUp(FX_VIEW_DURATION)}}function switchPinMark(c,b){var a=$("#pin-list .list[data-id='"+c+"']");switchClass(a.find(".label.fill-count"),"warning zoomin",b);switchClass(a.find(".action-reply"),"primary",!b);switchClass(a.find(".action-reply"),"success",b);return a}function searchUser(b,a){b.count=COUNT.USER_SEARCH;if(a){clrUsersPopup()}switchVisible("#users-award",false);loadFromLM("profile/search",b,addToUsersPopup);return b}function searchFollowing(b,a){b=b||{};if(a){clrUsersPopup()}switchVisible("#users-award",false);b.count=COUNT.USER;b.user=currentProfile.username;loadFromLM("following",b,addToUsersPopup);return b}function searchFollower(b,a){b=b||{};if(a){clrUsersPopup()}switchVisible("#users-award",false);b.count=COUNT.USER;b.user=currentProfile.username;lastestUsersReq=loadFromLM("followers",b,addToUsersPopup);return b}function searchBadgeWinners(b,a){b=b||{};if(a){clrUsersPopup()}b.count=COUNT.USER_BADGE;lastestUsersReq=loadFromLM("badge/winners",b,addToUsersPopup);usersMoreFN=searchBadgeWinners;return b}function loadMoreUsers(){usersMoreFN({before:lastestUsersID})}function searchUserSubmit(a){a.preventDefault();var b={q:$("#users-searchbox").val()};lastestUsersID="";searchUser(b,true);usersMoreFN=searchUser}function badgeTranslate(d){if(isLevel(d)){var a=HASH.levelName[d];return a[0]+" ("+a[1]+"/16)"}var c=d.split("_");var b=badgeSearch(d);b[0]=b[0]||[];return(b[0][0]||c[0])+(b[1]||c[1])}function isLevel(a){return !!HASH.levelName[a]}function badgeSearch(a){var b=a.split("_");return[HASH.badgeName[b[0]]||null,HASH.badgeLevel[b[1]]||null]}function compareBadgeLevel(d,c){return badgeOrder(d)>badgeOrder(c)}function badgeOrder(b){var a=b.split("_");var c=a[a.length-1];return({bronze:0,silver:1,gold:2})[c]}var cookie=null;var cookieObject={init:function(){assert(!cookie,"cookieObject.init","cookie is not null.");cookie={};var b=$.cookie();for(var a in b){cookieObject.load(a)}},flush:function(b,c){if(b){return cookieObject.save(b,cookie[b],c)}for(var a in cookie){cookieObject.save(a,cookie[a],c)}},save:function(a,c,b){cookie[a]=c;if(c instanceof Object){val=JSON.stringify(c)}else{val=c}return $.cookie(a,val,b)},load:function(a){if(cookie[a]){return cookie[a]}var c=$.cookie(a);try{return cookie[a]=JSON.parse(c)}catch(b){return cookie[a]=c}}};function modalNavigate(b,c,a){modal(b,c,a,{callbacks:{close:function(){try{location.hash="#!";history.replaceState(null,"",window.location.pathname+window.location.search)}catch(d){}}}})}function getURLParamObject(a){var b,d=/\+/g,c=/([^&=]+)=?([^&]*)/g,g=function(h){return decodeURIComponent(h.replace(d," "))},f=a.substring(1);var e={};while(b=c.exec(f)){e[g(b[1])]=g(b[2])}return e}function initHashRoutes(){var d=function(){var h=currentModal();return h&&h.data.src[0].id!="popup-notfound"};var a=function(h){modal("#popup-notfound",false,true);$("#popup-notfound").find("code.fill-hash").html(h.current)};var e=function(){if(d()){modalHide()}};var f=function(h){};var b=function(h){console.log("[HASH] interpreted",h,this.params)};var g=function(){if(!Path.routes.previous){return true}var h=Path.routes.previous.split("?");var i=location.hash.split("?");return !(h[0].replaceAll("/","")==i[0].replaceAll("/",""))};var c=function(){var i=this.params.id;var h=this.params.restArg;if(!g(h)){return}modalNavigate("#popup-reply",false,false);clrReplyPopup(true);$("#postreply-id").val(i);getDetailedPost({id:i});if(h){f(h)}b.call(this,"post")};Path.rescue(function(){if(!this.current||this.current=="#!"){e();return}a(this);console.log("[Path/rescue] not found.")});Path.map("#!/post(/:id)/").to(c);Path.map("#!/post(/:id)(/:restArg)").to(c);Path.listen()}function urlData(a,b){return a+"?"+b}function UNKNOWN(a){return TAG("span",COLOR_CLASS.UNKNOWN,a||"???")}function BADGE(a){if(isLevel(a)){return""}return URL_BADGE_BASE+"badge_"+a+"_240.png"}function TAGb(b){var a=badgeSearch(b.badge);if(!a[0]||!a[1]){return""}return TAG("img","shadow-award action-award","src='"+BADGE(b.badge)+"' data-badge='"+b.badge+"' data-subject='"+b.subject+"' data-date='"+b.date+"'","")}function TAGb2(a){var b=BADGE(a);return TAG("a","imglightbox","href='"+b+"' rel='player=img'",TAG("img","shadow-award","src='"+b+"'",""))}function TAGi(a,b){return TAGl(imageLM(a,"m"),imageLM(a,"X"),b,true)}function TAGl(d,e,f,c){e=e||d;if(!c){f=f||160}var b="shadow"+(c?" autoScaleImage":"");var a="src='"+d+"'"+(f?" style='width:"+f+"px;height:"+f+"px'":"");return TAG("a","imglightbox","href='"+e+"' rel='player=img'",TAG("img",b,a,""))}function LINK(c,d){var b=d||c;b=truncateText(b,40);var a=" target='_blank'";if(c.indexOf("http://lm.twbbs.org")==0||c.indexOf("http://andy0130tw.qov.tw")==0||c.indexOf("http://learnmode.host22.com")==0){a=""}return TAG("a","","href='"+c+"'"+a,ICON("new-tab-2")+" "+b)}function TABLE(b,a){var f="";for(var e=0;e<b.length;++e){var d="";for(var c=0;c<b[e].length;c++){d+=TAG("td",b[e][c])}if(a){f+=TAG("tr",a(b[e]),d)}else{f+=TAG("tr",d)}}return f}function TABLE_HEADER(a){for(var b=0;b<a.length;++b){a[b]=TAG("th","text-left",a[b])}return TAG("thead",TAG("tr",a.join("")))}function extractDate(a){return new Date(a.getFullYear(),a.getMonth(),a.getDate())}function extractTime(a){return new Date((a.getHours()*3600+a.getMinutes()*60+a.getSeconds())*1000)}function dateGetDays(b){var a=Math.round((extractDate(new Date())-extractDate(b))/86400000);if(a==0){return"今天"}if(a==1){return"昨天"}if(a==2){return"前天"}if(a<=7){return a+"天前"}return false}function imageLM(b,a){return URL_IMAGE+b+(a?"?size="+a:"")}function listitem(d,e,b,a){var c={};if(typeof b=="object"){c=b}else{c={inner:b}}return TAG("div","list post"+(e?" autoheight":"")+(c.outer?" "+c.outer:""),"tabindex='0'"+(a?" data-id='"+a+"'":""),TAG("div","list-content"+(c.inner?" "+c.inner:""),d))}function listitemNull(b,a){return listitem(TAG("p","text-center",TAG("span","subheader-secondary",ICON("comments-5"))+"<br/>"+b))}function thumbitem(c,a,b,d){return TAG("div","image-container cursorhand"+(a?" "+a:""),"data-id='"+d+"'",TAG("img","","src='"+c+"'","")+b)}function processGrid(b,d){var c=[],e=[];var f=function(){e.push(TAG("span","row",c.join("")));c=[]};for(var a in b){c.push(b[a]);if(c.length==d){f()}}if(c.length){f()}return e}function nl2br(a){return a.replace(/\n/g,"<br/>\n")}function urlToLink(b){var a=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|;])/ig;return b.replace(a,function(d,g,e,f,c){return" "+LINK(g)})}function normalize(a){return a.replaceAll('\\"','"').replaceAll("\\\\","\\").replaceAll("\\'","'").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("ς","　")}function markupContent(a){a=a.replace(/--\s*(.+?)\s*--/g,"<del>$1</del>").replace(/\*\*\s*(.*?)\s*\*\*/g,"<strong>$1</strong>").replace(/__\s*(.+?)__\s*/g,"<u>$1</u>");return a}function processContent(c,a){if(a){var b=smartTrimmer(c);if(b){return nl2br(urlToLink(markupContent(normalize(b))))+TAG("span","text-muted","…(Read More)")}}return nl2br(urlToLink(markupContent(normalize(c))))}function macConverter(g){g=g.toUpperCase();var d=[],b="",e="_",c=true;for(var a=0;d.length<6;++a){var f=a<g.length?g[a]:e;if(f==e){c=false}if(f==e||(g[a]>="0"&&g[a]<="9")||(g[a]>="A"&&g[a]<="F")){b+=f;if(b.length==2){d.push(b);b=""}}}return{mac:d.join(":"),valid:c}}function extractSubject(c){var b=[];for(var a=0;a<c.length;++a){b.push(c[a].id)}return b}function isMyself(a){if(!myProfile){throw new Error("isMyself, myProfile is not ready!")}return a.id==myProfile.id}function needSubject(c){var a=["question","answer","!badge","watch","annotation"];for(var b=0;b<a.length;++b){if(c==a[b]){return true}}return false}function getRelationWithUser(a){if(a.is_blocked){if(a.is_blocked_by){return ICON("blocked")+" 互相封鎖"}else{return ICON("blocked")+" 已封鎖他"}}else{if(a.is_blocked_by){return ICON("blocked")+" 已封鎖你"}else{if(a.is_following){if(a.is_followed_by){return ICON("tab")+" 互相關注"}else{return ICON("bars")+" 已關注他"}}else{if(a.is_followed_by){return ICON("bars")+" 已關注你"}}}}return""}JSON=JSON||{};if(typeof JSON.parse!=="function"){cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}JSON.stringify=JSON.stringify||function(j){var k=typeof(j);if(k!="object"||j===null){if(k=="string"){j='"'+j+'"'}return String(j)}else{var i,g,l=[],h=(j&&j.constructor==Array);for(i in j){g=j[i];k=typeof(g);if(k=="string"){g='"'+g+'"'}else{if(k=="object"&&g!==null){g=JSON.stringify(g)}}l.push((h?"":'"'+i+'":')+String(g))}return(h?"[":"{")+String(l)+(h?"]":"}")}};